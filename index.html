<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>유병자 인수가이드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekSDsnbTsiJjqsIDsnbTrk5wiLCJzaG9ydF9uYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekyIsInN0YXJ0X3VybCI6Ii4vaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjZmY3ZjAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGY5ZmEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yV3lCM2FXUjBhRDBpTWpRd0lpQm9aV2xuYUhROUlqSTBNQ0lnZG1sbGQwSnZlRDBpTUNBd0lESTBNQ0F5TkRBaUlHWnBiR3c5SWlObVpqZG1NREFpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaaTh5TURBd0wzTjJaeUkrUEdOcGNtTnNaU0JqZUQwaU1USTBJaUJqZVQwaU1USTBJaUJ5UFNJeE1ERWlJR1pwYkd3OUlpTm1aalk0REFBMU9VNGlMejRBUEhCaGRHZ2daRDBpVFRFME9TQXRNRGxDTGpBeFNIazNOem93TlFGc05qZ3VPRGd1TURNMUxqQXhObDBpSUdacGJHdzlJaU5tWmpkbU1EQWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" />
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.reset{
      background:#dc3545;
      margin-top:8px;
    }
    button.reset:hover{background:#c82333}
    button.debug{
      background:#17a2b8;
      margin-bottom:8px;
    }
    button.debug:hover{background:#138496}
    button.logout{
      background:#28a745;
      margin-bottom:8px;
    }
    button.logout:hover{background:#218838}
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#137333; font-size:13px}
    .debug{color:#17a2b8; font-size:12px; margin-top:.5rem; background:#f8f9fa; padding:8px; border-radius:5px; font-family:monospace; white-space:pre-wrap; max-height:200px; overflow-y:auto;}
    .container-narrow{max-width:760px}
    .results{margin-top:1rem}
    .result-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:12px;
    }
    .result-title{
      font-size:18px;
      font-weight:700;
      color:#222;
      margin-bottom:6px;
    }
    .result-sub{color:#444; margin:.25rem 0 .5rem 0}
    .info-table{
      width:100%;
      border-collapse:collapse;
      margin-top:.25rem;
      font-size:14px;
    }
    .info-table th,.info-table td{
      border:1px solid var(--border);
      padding:8px;
      text-align:center;
      white-space:nowrap;
    }
    .restrictions{
      margin-top:.5rem;
      padding:.5rem .75rem;
      background:#fafafa;
      border:1px dashed var(--border);
      border-radius:10px;
      font-size:14px;
      white-space:pre-line;
    }
    .meta{
      margin-top:.5rem;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .install-prompt{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--hanwha);
      color:white;
      padding:12px 20px;
      border-radius:25px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      display:none;
      z-index:1000;
      cursor:pointer;
      font-weight:700;
    }
    .admin-btn{
      position:fixed;
      bottom:10px;
      right:10px;
      width:40px;
      height:40px;
      background:rgba(108,117,125,0.8);
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:12px;
      font-weight:700;
      border:none;
    }
    .log-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      margin-bottom:8px;
      font-size:14px;
    }
    .log-header{
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:4px;
    }
    .log-time{
      color:var(--muted);
      font-size:12px;
    }
    .log-search{
      background:#f0f8ff;
      padding:4px 8px;
      border-radius:5px;
      margin-top:4px;
      font-family:monospace;
    }
    .user-info{
      position:fixed;
      top:10px;
      right:10px;
      background:rgba(255,127,0,0.1);
      padding:8px 12px;
      border-radius:20px;
      font-size:12px;
      color:var(--hanwha);
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .user-info button{
      padding:4px 8px;
      font-size:11px;
      margin:0;
      width:auto;
      min-width:50px;
    }
    .loading{
      display:inline-block;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
  </style>
</head>
<body>
 <!-- 로그인 화면 -->
<section id="loginScreen" class="screen">
  <div class="app-title">한화손보 유병자 인수 가이드</div>
  <div class="card">
    <h2>로그인</h2>
    <div class="row">
      <input id="empno" type="text" placeholder="코드 입력" autocomplete="username" />
    </div>
    <div class="row">
      <input id="password" type="password" placeholder="비밀번호 입력" autocomplete="current-password" />
      <div class="hint">코드는 사전 승인된 기관에 부여됩니다.</div>
    </div>
    <button id="loginBtn">로그인</button>
    <button id="installBtn" class="secondary">홈화면에 추가</button>
    <div id="loginMsg" class="error" role="alert" aria-live="polite"></div>
    <div class="meta" id="empMeta"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 하세봉 all rights reserved.</div>
  </div>
</section>

<!-- 검색 화면 -->
<section id="searchScreen" class="screen" style="display:none;">
  <div class="user-info" id="userInfo">
    <span id="userText"></span>
    <button id="logoutBtn" class="logout">로그아웃</button>
  </div>
  <div class="app-title">한화손보 유병자 인수 가이드</div>
  <div class="card container-narrow">
    <h2 style="margin-bottom:.5rem;">질병명 검색</h2>
    <div class="row">
      <input id="searchInput" type="text" placeholder="예시: 용종, 골절, 당뇨 등" />
    </div>
    <button id="searchBtn" title="검색">검색</button>
    <div class="results" id="results"></div>
    <div class="meta" id="disMeta"></div>
    <div class="debug" id="debugInfo" style="display:none;"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 하세봉 all rights reserved.</div>
  </div>
</section>

  <!-- 관리자 로그 화면 -->
  <section id="adminScreen" class="screen" style="display:none;">
    <div class="app-title">관리자 로그 조회</div>
    <div class="card container-narrow">
      <h2>사용자 활동 로그</h2>
      <div class="row">
        <input id="adminPassword" type="password" placeholder="관리자 비밀번호를 입력하세요." />
      </div>
      <button id="loadLogsBtn">로그 불러오기</button>
      <button id="testGitHubBtn" class="debug">GitHub 연결 테스트</button>
      <button id="resetLoginBtn" class="reset">모든 사용자 로그인 초기화</button>
      <button id="backToSearchBtn" class="secondary">검색화면으로 돌아가기</button>
      <div id="adminMsg" class="error"></div>
      <div class="debug" id="githubDebug"></div>
      <div class="meta" id="logStats"></div>
      <div id="logResults" class="results"></div>
    </div>
  </section>

  <!-- PWA 설치 프롬프트 -->
  <div id="installPrompt" class="install-prompt">홈화면에 추가하기</div>

  <!-- 관리자 버튼 (기본적으로 숨김) -->
  <button id="adminBtn" class="admin-btn" title="관리자" style="display:none; visibility:hidden;">Admin</button>

<script>
// 전역 변수
let employees = [];
let diseases = [];
let currentUser = null;
let userLogs = [];

// PWA 설치 관련
let deferredPrompt;

// 데이터 URL
const EMP_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/employees.json";
const DIS_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/diseases.json";

// GitHub 로그 설정
const GITHUB_CONFIG = {
  owner: 'bsens90-wq',
  repo: 'patient-guide-logs',
  path: 'logs/user_logs.json',
  token: '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',
  branch: 'main'
};

// 디버그 정보 표시
function showDebug(message, isError = false) {
  const debugElement = document.getElementById('debugInfo');
  const githubDebugElement = document.getElementById('githubDebug');
  
  const timestamp = new Date().toLocaleTimeString();
  const debugMsg = `[${timestamp}] ${message}\n`;
  
  if (debugElement) {
    debugElement.style.display = 'block';
    debugElement.textContent += debugMsg;
    debugElement.scrollTop = debugElement.scrollHeight;
  }
  if (githubDebugElement) {
    githubDebugElement.textContent += debugMsg;
    githubDebugElement.scrollTop = githubDebugElement.scrollHeight;
  }
  
  console.log(isError ? 'ERROR:' : 'DEBUG:', message);
}

// GitHub 연결 테스트
async function testGitHubConnection() {
  const msg = document.getElementById("adminMsg");
  const password = document.getElementById("adminPassword").value.trim();
  
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }
  
  msg.textContent = "";
  showDebug("=== GitHub 연결 테스트 시작 ===");
  
  // 토큰 상태 확인
  showDebug(`토큰 길이: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : '없음'}`);
  showDebug(`토큰 시작: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.substring(0, 10) + '...' : '없음'}`);
  
  if (!GITHUB_CONFIG.token) {
    showDebug("GitHub 토큰이 설정되지 않았습니다.", true);
    msg.textContent = "토큰이 설정되지 않았습니다.";
    return;
  }

  try {
    // 1. 기본 GitHub API 응답 테스트
    showDebug("1. GitHub API 기본 연결 테스트...");
    const basicResponse = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    showDebug(`기본 API 응답: ${basicResponse.status} ${basicResponse.statusText}`);
    
    if (basicResponse.ok) {
      const userData = await basicResponse.json();
      showDebug(`인증된 사용자: ${userData.login}`);
    } else {
      const errorData = await basicResponse.json();
      showDebug(`기본 API 오류: ${JSON.stringify(errorData)}`, true);
    }

    // 2. 리포지토리 접근 테스트
    showDebug("2. 리포지토리 접근 테스트...");
    const repoUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
    showDebug(`리포지토리 URL: ${repoUrl}`);
    
    const repoResponse = await fetch(repoUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`리포지토리 응답: ${repoResponse.status} ${repoResponse.statusText}`);

    if (!repoResponse.ok) {
      const errorText = await repoResponse.text();
      showDebug(`리포지토리 오류 내용: ${errorText}`, true);
      throw new Error(`리포지토리 접근 실패: ${repoResponse.status}`);
    }

    const repoData = await repoResponse.json();
    showDebug(`리포지토리명: ${repoData.name}, 공개여부: ${repoData.private ? 'Private' : 'Public'}`);

    // 3. 파일 접근 테스트
    showDebug("3. 로그 파일 접근 테스트...");
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    showDebug(`파일 URL: ${fileUrl}`);
    
    const fileResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`파일 접근 응답: ${fileResponse.status} ${fileResponse.statusText}`);

    if (fileResponse.ok) {
      const fileData = await fileResponse.json();
      showDebug(`파일 존재함: ${GITHUB_CONFIG.path}`);
      showDebug(`파일 크기: ${fileData.size} bytes, SHA: ${fileData.sha}`);
      
      try {
        const content = atob(fileData.content);
        const logs = JSON.parse(content);
        showDebug(`현재 로그 개수: ${logs.length}개`);
        
        if (logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          showDebug(`최근 로그: ${lastLog.date} - ${lastLog.empno} - ${lastLog.action}`);
        }
      } catch (parseError) {
        showDebug(`파일 파싱 오류: ${parseError.message}`, true);
      }
      
    } else if (fileResponse.status === 404) {
      showDebug("파일이 존재하지 않음. 첫 로그 저장 시 자동 생성됩니다.");
      
      // 4. 파일 생성 테스트
      showDebug("4. 파일 생성 테스트...");
      const testLog = [{
        empno: "TEST",
        action: "test_connection",
        details: "GitHub 연결 테스트",
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('ko-KR')
      }];
      
      const createResponse = await fetch(fileUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'GitHub 연결 테스트 - 로그 파일 생성',
          content: btoa(JSON.stringify(testLog, null, 2)),
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (createResponse.ok) {
        showDebug("테스트 파일 생성 성공!");
      } else {
        const createErrorText = await createResponse.text();
        showDebug(`파일 생성 실패: ${createResponse.status} - ${createErrorText}`, true);
      }
      
    } else {
      const errorText = await fileResponse.text();
      showDebug(`파일 접근 오류: ${fileResponse.status} - ${errorText}`, true);
    }

    showDebug("=== GitHub 연결 테스트 완료 ===");
    msg.innerHTML = '<span class="success">GitHub 연결 테스트 완료! 디버그 정보를 확인하세요.</span>';

  } catch (error) {
    showDebug(`GitHub 연결 테스트 실패: ${error.message}`, true);
    msg.textContent = `GitHub 연결 실패: ${error.message}`;
  }
}

// 자동 로그인 체크
function checkAutoLogin() {
  const savedUser = localStorage.getItem('hwg_current_user');
  if (savedUser) {
    currentUser = savedUser;
    showLoginSuccess();
    showDebug(`자동 로그인: ${currentUser}`);
  }
}

// 로그인 성공 처리
function showLoginSuccess() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("searchScreen").style.display = "flex";
  document.getElementById("userText").textContent = `로그인: ${currentUser}`;
  document.getElementById("searchInput").focus();
}

// 로그아웃 처리
function logout() {
  if (currentUser) {
    // 로그아웃 로그 기록
    saveLogToGitHub(currentUser, 'logout', '사용자 로그아웃');
    
    // 로그인 상태 초기화
    localStorage.removeItem('hwg_current_user');
    currentUser = null;
    
    // 화면 전환
    document.getElementById("searchScreen").style.display = "none";
    document.getElementById("adminScreen").style.display = "none";
    document.getElementById("loginScreen").style.display = "flex";
    
    // 입력 필드 초기화
    document.getElementById("empno").value = "";
    document.getElementById("password").value = "";
    document.getElementById("searchInput").value = "";
    document.getElementById("results").innerHTML = "";
    
    showDebug("로그아웃 완료");
  }
}

// GitHub API를 통한 로그 추가 (중앙 로그 관리)
async function appendLogToGitHub(newLog) {
  try {
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    
    // 현재 파일 내용 가져오기
    const getResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    let existingLogs = [];
    let sha = null;

    if (getResponse.ok) {
      const data = await getResponse.json();
      sha = data.sha;
      const content = atob(data.content);
      existingLogs = JSON.parse(content);
      showDebug(`기존 로그 ${existingLogs.length}개 발견`);
    } else if (getResponse.status === 404) {
      showDebug("파일이 존재하지 않음. 새로 생성합니다.");
    } else {
      throw new Error(`파일 가져오기 실패: ${getResponse.status}`);
    }

    // 새 로그 추가
    existingLogs.push(newLog);
    
    // 최대 1000개 로그만 유지
    if (existingLogs.length > 1000) {
      existingLogs = existingLogs.slice(-1000);
    }

    const newContent = btoa(JSON.stringify(existingLogs, null, 2));

    // GitHub에 업데이트
    const updatePayload = {
      message: `Add log: ${newLog.action} by ${newLog.empno}`,
      content: newContent,
      branch: GITHUB_CONFIG.branch
    };
    
    if (sha) {
      updatePayload.sha = sha;
    }

    const updateResponse = await fetch(fileUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatePayload)
    });

    if (!updateResponse.ok) {
      const errorText = await updateResponse.text();
      throw new Error(`GitHub 업데이트 실패: ${updateResponse.status} - ${errorText}`);
    }

    showDebug(`GitHub 로그 저장 성공: ${newLog.action} by ${newLog.empno}`);

  } catch (error) {
    showDebug(`GitHub 로그 저장 오류: ${error.message}`, true);
    
    // GitHub 저장 실패시 로컬에 백업
    const localLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    localLogs.push(newLog);
    if (localLogs.length > 100) {
      localLogs.splice(0, localLogs.length - 100);
    }
    localStorage.setItem('backup_logs', JSON.stringify(localLogs));
    showDebug("로컬 백업에 저장됨");
  }
}

// 중앙 로그 저장 함수 (GitHub 연동)
async function saveLogToGitHub(empno, action, details = '') {
  const newLog = {
    empno,
    action,
    details,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleString('ko-KR'),
    userAgent: navigator.userAgent.substring(0, 100) // 브라우저 정보 (제한적)
  };
  
  // 비동기로 GitHub에 저장
  appendLogToGitHub(newLog);
}

// GitHub에서 로그 불러오기
async function loadLogsFromGitHub() {
  // GitHub 연동이 비활성화된 경우 로컬 백업만 사용
  if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token) {
    showDebug("GitHub 연동이 비활성화됨. 로컬 백업 사용");
    const backupLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    if (backupLogs.length > 0) {
      showDebug(`로컬 백업에서 ${backupLogs.length}개 로그 사용`);
    }
    return backupLogs;
  }

  try {
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      if (response.status === 404) {
        showDebug("로그 파일이 아직 생성되지 않았습니다.");
        return [];
      }
      throw new Error(`GitHub API 오류: ${response.status}`);
    }

    const data = await response.json();
    const content = atob(data.content);
    const logs = JSON.parse(content);
    showDebug(`GitHub에서 ${logs.length}개 로그 불러옴`);
    return logs;
  } catch (error) {
    showDebug(`GitHub 로그 불러오기 실패: ${error.message}`, true);
    
    // GitHub에서 불러오기 실패시 로컬 백업 사용
    const backupLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    if (backupLogs.length > 0) {
      showDebug(`로컬 백업에서 ${backupLogs.length}개 로그 사용`);
    }
    return backupLogs;
  }
}

// 로그 기록 함수 (기존 로직 유지하면서 GitHub 연동 추가)
function saveLog(empno, action, details = '') {
  saveLogToGitHub(empno, action, details);
}

// 관리자 로그인 상태 초기화 (실제 작동하도록 수정)
async function resetAllLogins() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }

  try {
    // 현재 모든 사용자의 로그인 상태 초기화
    localStorage.removeItem('hwg_current_user');
    
    // 현재 사용자도 로그아웃 처리
    if (currentUser) {
      const previousUser = currentUser;
      currentUser = null;
      
      // 화면을 로그인 화면으로 전환
      document.getElementById("searchScreen").style.display = "none";
      document.getElementById("adminScreen").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
      
      // 입력 필드 초기화
      document.getElementById("empno").value = "";
      document.getElementById("password").value = "";
      
      // 초기화 로그 기록
      await saveLogToGitHub('ADMIN', 'reset_all_logins', `All user login states reset by admin. Previous user: ${previousUser}`);
      
      showDebug(`관리자에 의한 전체 로그인 초기화 완료. 이전 사용자: ${previousUser}`);
    } else {
      // 초기화 로그 기록
      await saveLogToGitHub('ADMIN', 'reset_all_logins', 'All user login states reset by admin');
      showDebug("관리자에 의한 전체 로그인 초기화 완료");
    }
    
    msg.innerHTML = '<span class="success">모든 사용자의 로그인 상태가 초기화되었습니다. 로그인 화면으로 이동합니다.</span>';
    
    // 3초 후 로그인 화면으로 이동
    setTimeout(() => {
      document.getElementById("adminScreen").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
    }, 3000);

  } catch (error) {
    showDebug(`로그인 초기화 중 오류: ${error.message}`, true);
    msg.textContent = `초기화 중 오류가 발생했습니다: ${error.message}`;
  }
}

// PWA 설치 이벤트
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installPrompt').style.display = 'block';
});

// JSON 로더
async function loadJsonFlexible(url){
  const res = await fetch(url + "?t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("네트워크 오류: " + res.status);
 
  const text = await res.text();
  const cleaned = text.replace(/^\uFEFF/, "");
  let json = JSON.parse(cleaned);

  if(json && typeof json === "object" && !Array.isArray(json) && Array.isArray(json.data)){
    json = json.data;
  }
  if(!Array.isArray(json)) throw new Error("JSON이 배열이 아닙니다.");
 
  return json;
}

// 데이터 로드
async function loadAllData(){
  try{
    const [emp, dis] = await Promise.all([
      loadJsonFlexible(EMP_URL),
      loadJsonFlexible(DIS_URL)
    ]);

    employees = emp.map(e => ({
      empno: String(e.empno || e.code || "").trim(),
      password: String(e.password || "").trim()
    })).filter(e => e.empno && e.password);

    diseases = dis.map(d => ({
      name: String(d.name || "").trim(),
      acceptance: String(d.acceptance || ""),
      signature355: String(d.signature355 || ""),
      treatmentDays: String(d.treatmentDays || ""),
      surgery: String(d.surgery || ""),
      recurrence: String(d.recurrence || ""),
      restrictions: String(d.restrictions || "")
    })).filter(d => d.name);

    document.getElementById("empMeta").textContent =
      `승인사번 ${employees.length}건 • 질병데이터 ${diseases.length}건 • 관리자: 8091768`;

    showDebug(`데이터 로드 완료: 직원 ${employees.length}명, 질병 ${diseases.length}개`);

  }catch(err){
    console.error("데이터 로드 실패:", err);
    showDebug(`데이터 로드 실패: ${err.message}`, true);
    document.getElementById("loginMsg").textContent = "데이터 로드 실패";
  }
}

// 로그인
function login(){
  const empno = document.getElementById("empno").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  if(!empno || !password) {
    msg.textContent = "코드와 비밀번호를 모두 입력해주세요.";
    return;
  }

  if(!employees.length){
    msg.textContent = "데이터가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.";
    return;
  }

  const user = employees.find(u => u.empno === empno && u.password === password);
 
  if(user){
    currentUser = empno;
    
    // 로그인 상태 저장 (자동 로그인용)
    localStorage.setItem('hwg_current_user', empno);
    
    // 로그인 로그 기록
    saveLog(empno, 'login', `Login successful from ${window.location.href}`);
   
    showLoginSuccess();
    msg.textContent = "";
    showDebug(`로그인 성공: ${empno}`);
  }else{
    msg.textContent = "코드 또는 비밀번호가 올바르지 않습니다.";
    showDebug(`로그인 실패: ${empno}`);
  }
}

// 보험회사 연락처 표시
function showInsuranceContacts() {
  const insuranceSection = document.getElementById("insuranceContacts");
  const insuranceList = document.getElementById("insuranceList");
  
  console.log("showInsuranceContacts 호출됨");
  console.log("insuranceCompanies 길이:", insuranceCompanies.length);
  console.log("insuranceSection:", insuranceSection);
  console.log("insuranceList:", insuranceList);
  
  if (!insuranceCompanies.length) {
    console.log("보험회사 데이터가 없음");
    insuranceSection.style.display = "none";
    return;
  }
  
  insuranceSection.style.display = "block";
  console.log("보험회사 섹션 표시함");
  
  const cards = insuranceCompanies.map(company => {
    const faxDisplay = company.fax === "콜센터 전화 접수" ? 
      `<span style="color: #888; font-style: italic;">${company.fax}</span>` : 
      company.fax;
    
    return `
      <div class="insurance-card">
        <img src="${company.logoUrl}" alt="${company.company}" class="insurance-logo" 
             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <div style="display:none; width:120px; height:40px; background:#f0f0f0; border-radius:8px; flex-shrink:0; align-items:center; justify-content:center; font-size:12px; color:#666;">${company.company}</div>
        <div class="insurance-info">
          <div class="insurance-company">${company.company}</div>
          <div class="insurance-contact">
            <div class="contact-item">
              <span class="contact-icon">📞</span>
              <a href="tel:${company.callCenter.replace(/-/g, '')}">${company.callCenter}</a>
            </div>
            <div class="contact-item">
              <span class="contact-icon">📠</span>
              <span>${faxDisplay}</span>
            </div>
            <div class="contact-item">
              <span class="contact-icon">🔗</span>
              <a href="${company.termsUrl}" target="_blank" rel="noopener">약관함</a>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  insuranceList.innerHTML = cards;
  console.log("보험회사 카드 HTML 생성됨:", cards.length);
  showDebug(`보험회사 연락처 ${insuranceCompanies.length}개 표시됨`);
}

// 검색 정규화
function normalize(str){
  return String(str || "").toLowerCase().replace(/[\sÂ·,\-\.]/g, "");
}

// 검색
function search(){
  const query = document.getElementById("searchInput").value.trim();
  const results = document.getElementById("results");
 
  if(!query){
    results.innerHTML = '<div class="hint">검색어를 입력하세요.</div>';
    return;
  }

  if(!diseases.length) {
    results.innerHTML = '<div class="error">질병 데이터가 로드되지 않았습니다.</div>';
    return;
  }

  // 검색 로그 저장
  if(currentUser) {
    saveLog(currentUser, 'search', query);
    showDebug(`검색 실행: ${currentUser} - "${query}"`);
  }

  const tokens = query.split(/[\sÂ·,\-\.]+/).filter(Boolean).map(normalize);
 
  const matched = diseases.filter(d => {
    const name = normalize(d.name);
   
    // 기본 검색 (공백으로 분리된 토큰들이 모두 포함)
    if(tokens.every(token => name.includes(token))) {
      return true;
    }
   
    // 단일 토큰 분할 검색 (3글자 이상, 2글자씩 조합, 순서 고려)
    if(tokens.length === 1) {
      const token = tokens[0];
      if(token.length >= 3) {
        for(let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
         
          if(left.length >= 2 && right.length >= 2) {
            const leftPos = name.indexOf(left);
            const rightPos = name.indexOf(right);
           
            if(leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              return true;
            }
          }
        }
      }
    }
   
    return false;
  });

  if(!matched.length){
    results.innerHTML = '<div class="hint">검색 결과가 없습니다.</div>';
    return;
  }

  results.innerHTML = matched.map(d => `
    <div class="result-card">
      <div class="result-title">${d.name}</div>
      <div class="result-sub">인수기준: ${d.acceptance || "-"}</div>
      <div class="result-sub">시그니처355: ${d.signature355 || "-"}</div>
      <table class="info-table">
        <tr><th>치료일수</th><th>수술여부</th><th>재발여부</th></tr>
        <tr>
          <td>${d.treatmentDays || "-"}</td>
          <td>${d.surgery || "-"}</td>
          <td>${d.recurrence || "-"}</td>
        </tr>
      </table>
      <div class="restrictions">제한사항: ${d.restrictions || "없음"}</div>
    </div>
  `).join('');

  showDebug(`검색 결과: ${matched.length}개 발견`);
}

// 관리자 로그 불러오기 (GitHub 연동)
async function loadLogs() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  const loadBtn = document.getElementById("loadLogsBtn");
 
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }
 
  msg.textContent = "";
  loadBtn.innerHTML = '<span class="loading">⟳</span> 로그 불러오는 중...';
  loadBtn.disabled = true;

  try {
    showDebug("관리자 로그 불러오기 시작...");
    
    // GitHub에서 로그 불러오기
    userLogs = await loadLogsFromGitHub();
    userLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
   
    const stats = document.getElementById("logStats");
    const results = document.getElementById("logResults");
   
    // 통계
    const totalLogs = userLogs.length;
    const uniqueUsers = new Set(userLogs.map(l => l.empno)).size;
    const loginCount = userLogs.filter(l => l.action === 'login').length;
    const searchCount = userLogs.filter(l => l.action === 'search').length;
    const logoutCount = userLogs.filter(l => l.action === 'logout').length;
   
    stats.textContent = `전체 ${totalLogs}개 | 사용자 ${uniqueUsers}명 | 로그인 ${loginCount}회 | 검색 ${searchCount}회 | 로그아웃 ${logoutCount}회`;
    showDebug(`로그 통계: 총 ${totalLogs}개, 사용자 ${uniqueUsers}명`);
   
    // 로그 목록
    if(userLogs.length === 0) {
      results.innerHTML = '<div class="hint">로그 데이터가 없습니다.</div>';
    } else {
      const actionNames = {
        'login': '로그인',
        'logout': '로그아웃', 
        'search': '검색',
        'reset_all_logins': '전체 로그인 초기화',
        'test_connection': 'GitHub 연결 테스트'
      };

      results.innerHTML = userLogs.slice(0, 50).map(log => `
        <div class="log-card">
          <div class="log-header">코드: ${log.empno} - ${actionNames[log.action] || log.action}</div>
          <div class="log-time">${log.date}</div>
          ${log.details ? `<div class="log-search">상세: "${log.details}"</div>` : ''}
        </div>
      `).join('');
      
      if(userLogs.length > 50) {
        results.innerHTML += `<div class="hint">최근 50개 로그만 표시됩니다. (전체 ${userLogs.length}개)</div>`;
      }
    }
    
    showDebug("로그 불러오기 완료");
    msg.innerHTML = '<span class="success">로그를 성공적으로 불러왔습니다.</span>';
  } catch (error) {
    showDebug(`로그 불러오기 실패: ${error.message}`, true);
    msg.textContent = "로그 불러오기 실패: " + error.message;
  } finally {
    loadBtn.innerHTML = '로그 불러오기';
    loadBtn.disabled = false;
  }
}

// 이벤트 리스너
document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM 로드 완료");
  
  try {
    // 보험회사 데이터 먼저 초기화
    initializeInsuranceData();
    console.log("보험회사 데이터 초기화 완료");
    
    // 데이터 로드 및 자동 로그인 체크
    Promise.all([loadAllData()]).then(() => {
      checkAutoLogin();
    }).catch(err => {
      console.error("데이터 로드 중 오류:", err);
    });
  } catch(err) {
    console.error("초기화 중 오류:", err);
  }
 
  // 로그인 이벤트 리스너
  try {
    const loginBtn = document.getElementById('loginBtn');
    const empnoInput = document.getElementById('empno');
    const passwordInput = document.getElementById('password');
    
    console.log("로그인 버튼 요소:", loginBtn);
    console.log("입력 필드들:", empnoInput, passwordInput);
    
    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        console.log("로그인 버튼 클릭됨");
        login();
      });
    }
    
    if (empnoInput) {
      empnoInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') {
          passwordInput && passwordInput.focus();
        }
      });
    }
    
    if (passwordInput) {
      passwordInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') login();
      });
    }
  } catch(err) {
    console.error("로그인 이벤트 리스너 설정 오류:", err);
  }

  // 로그아웃 이벤트 리스너
  try {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
    }
  } catch(err) {
    console.error("로그아웃 이벤트 리스너 설정 오류:", err);
  }
 
  // 검색 이벤트 리스너
  try {
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    
    if (searchBtn) {
      searchBtn.addEventListener('click', search);
    }
    
    if (searchInput) {
      searchInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') search();
      });
    }
  } catch(err) {
    console.error("검색 이벤트 리스너 설정 오류:", err);
  }
 
  // 관리자 이벤트 리스너
  try {
    const adminBtn = document.getElementById('adminBtn');
    if (adminBtn) {
      adminBtn.addEventListener('click', () => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('searchScreen').style.display = 'none';
        document.getElementById('adminScreen').style.display = 'flex';
      });
    }
    
    const loadLogsBtn = document.getElementById('loadLogsBtn');
    const adminPassword = document.getElementById('adminPassword');
    
    if (loadLogsBtn) {
      loadLogsBtn.addEventListener('click', loadLogs);
    }
    
    if (adminPassword) {
      adminPassword.addEventListener('keydown', e => {
        if(e.key === 'Enter') loadLogs();
      });
    }

    // GitHub 테스트 버튼
    const testGitHubBtn = document.getElementById('testGitHubBtn');
    if (testGitHubBtn) {
      testGitHubBtn.addEventListener('click', testGitHubConnection);
    }

    // 로그인 상태 초기화 버튼
    const resetLoginBtn = document.getElementById('resetLoginBtn');
    if (resetLoginBtn) {
      resetLoginBtn.addEventListener('click', resetAllLogins);
    }
    
    const backToSearchBtn = document.getElementById('backToSearchBtn');
    if (backToSearchBtn) {
      backToSearchBtn.addEventListener('click', () => {
        document.getElementById('adminScreen').style.display = 'none';
        if(currentUser) {
          document.getElementById('searchScreen').style.display = 'flex';
        } else {
          document.getElementById('loginScreen').style.display = 'flex';
        }
      });
    }
  } catch(err) {
    console.error("관리자 이벤트 리스너 설정 오류:", err);
  }
 
  // PWA 설치 이벤트 리스너
  try {
    const installBtn = document.getElementById('installBtn');
    const installPrompt = document.getElementById('installPrompt');
    
    console.log("설치 버튼 요소:", installBtn);
    
    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        console.log("설치 버튼 클릭됨");
        if(deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installPrompt && (installPrompt.style.display = 'none');
        } else {
          alert('브라우저에서 홈화면 추가 기능을 사용해주세요.');
        }
      });
    }
    
    if (installPrompt) {
      installPrompt.addEventListener('click', () => {
        installBtn && installBtn.click();
      });
    }
  } catch(err) {
    console.error("PWA 이벤트 리스너 설정 오류:", err);
  }
  
  console.log("모든 이벤트 리스너 설정 완료");
});
</script>

</body>
</html>
