<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë™ì°½ì› ìœ ë³‘ì ì¸ìˆ˜ ê°€ì´ë“œ</title>
<style>
body {margin:0;font-family:'Segoe UI',sans-serif;background:#fff4e6;}
.container {max-width:600px;margin:3rem auto;padding:2rem;background:white;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.1);}
h1{text-align:center;margin-bottom:2rem;color:#ff6600;}
.form-group{margin-bottom:1.5rem;}
label{display:block;margin-bottom:0.5rem;font-weight:600;color:#333;}
input[type="text"], input[type="password"], input[type="file"]{width:100%;padding:10px;font-size:16px;border:2px solid #ddd;border-radius:6px;outline:none;transition:border-color 0.3s;}
input:focus{border-color:#ff6600;}
button{background:#ff6600;color:white;padding:10px 16px;border:none;border-radius:6px;font-size:16px;cursor:pointer;}
button:hover{background:#e65c00;}
.screen{display:none;}
.screen.active{display:block;}
.error{color:red;font-size:14px;margin-top:0.5rem;}
.success{color:green;font-size:14px;margin-top:0.5rem;}
.search-results{margin-top:2rem;}
.disease-title{font-size:1.2rem;font-weight:bold;margin-bottom:0.5rem;color:#ff6600;}
.acceptance-status{background:#fff7e6;padding:0.6rem;border-radius:5px;margin-bottom:1rem;border-left:4px solid #ff6600;}
.restrictions{background:#ffe5e0;padding:0.6rem;border-radius:5px;margin-top:1rem;}
.conditions-table{width:100%;border-collapse:collapse;margin-top:1rem;}
.conditions-table th, .conditions-table td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
.conditions-table th{background:#f8f9fa;}
.toggle-admin{position:fixed;bottom:20px;right:20px;background:#ffc107;color:#000;padding:0.6rem 1rem;font-size:14px;border:none;border-radius:6px;cursor:pointer;z-index:1000;}
.data-status{background:#e8f4fd;padding:0.8rem;border-radius:6px;margin:1rem 0;font-size:14px;}
.search-info{background:#e3f2fd;padding:0.8rem;border-radius:6px;margin-bottom:1rem;font-size:14px;}
.loading{display:none;text-align:center;color:#666;}
.sync-status{background:#d4edda;border:1px solid #c3e6cb;padding:0.6rem;border-radius:5px;margin:0.5rem 0;font-size:14px;}
.sync-error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;}
.update-indicator{position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:0.5rem;border-radius:5px;display:none;z-index:1001;}
</style>
</head>
<body>

<!-- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì•Œë¦¼ -->
<div id="update-indicator" class="update-indicator">ë°ì´í„° ì—…ë°ì´íŠ¸ë¨!</div>

<div class="container">
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="login-screen" class="screen active">
    <h1>ë¡œê·¸ì¸</h1>
    <div id="sync-status" class="sync-status">ì„œë²„ ì—°ê²° ì¤‘...</div>
    <form id="login-form">
      <div class="form-group">
        <label for="login-empno">ì‚¬ë²ˆ</label>
        <input type="text" id="login-empno" required />
      </div>
      <div class="form-group">
        <label for="login-password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="login-password" required />
      </div>
      <button type="submit">ë¡œê·¸ì¸</button>
      <div id="login-error" class="error"></div>
    </form>
  </div>

  <!-- ê²€ìƒ‰ í™”ë©´ -->
  <div id="main-screen" class="screen">
    <h1>ì§ˆë³‘ëª… ê²€ìƒ‰</h1>
    <div class="search-info">
      <strong>ê²€ìƒ‰ ê°€ëŠ¥í•œ ì§ˆë³‘:</strong> ì´ <span id="total-diseases">0</span>ê°œ<br>
      <strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> <span id="last-update">í™•ì¸ì¤‘...</span><br>
      <strong>ì„œë²„ ìƒíƒœ:</strong> <span id="server-connection" style="color:green;">ì—°ê²°ë¨</span>
    </div>
    <div class="form-group">
      <label for="disease-search">ê²€ìƒ‰ì–´</label>
      <input type="text" id="disease-search" placeholder="ì˜ˆ: ìš©ì¢…, ê³¨ì ˆ, ì—¼ì¢Œ, ê³ í˜ˆì••, ë‹¹ë‡¨ ë“±" />
    </div>
    <button type="button" onclick="searchDisease()">ê²€ìƒ‰</button>
    <div class="loading" id="search-loading">ê²€ìƒ‰ ì¤‘...</div>
    <div id="search-results" class="search-results"></div>
  </div>

  <!-- ê´€ë¦¬ì í™”ë©´ -->
  <div id="admin-screen" class="screen">
    <h1>ê´€ë¦¬ì ëª¨ë“œ</h1>
    
    <div class="data-status">
      <strong>í˜„ì¬ ë°ì´í„°:</strong><br>
      ìŠ¹ì¸ì‚¬ë²ˆ: <span id="emp-count">0</span>ê°œ<br>
      ì§ˆë³‘ë°ì´í„°: <span id="disease-count">0</span>ê°œ<br>
      <strong>GitHub ì—°ë™:</strong> <span id="github-status">í™œì„±í™”ë¨</span>
    </div>
    
    <div class="form-group">
      <label>ìŠ¹ì¸ ì‚¬ë²ˆ CSV ì—…ë¡œë“œ (ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ë°˜ì˜)</label>
      <input type="file" id="employee-csv" accept=".csv" />
      <button onclick="uploadEmployeeData()" style="background:#007bff;margin-top:0.5rem;">ì „ì²´ ì—…ë°ì´íŠ¸</button>
      <div id="emp-upload-status" class="success"></div>
    </div>
    
    <div class="form-group">
      <label>ì§ˆë³‘ ë°ì´í„° CSV ì—…ë¡œë“œ (ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ë°˜ì˜)</label>
      <input type="file" id="disease-csv" accept=".csv" />
      <button onclick="uploadDiseaseData()" style="background:#007bff;margin-top:0.5rem;">ì „ì²´ ì—…ë°ì´íŠ¸</button>
      <div id="disease-upload-status" class="success"></div>
    </div>
    
    <div class="form-group">
      <button onclick="forceUpdateAllUsers()" style="background:#dc3545;font-weight:bold;">ğŸš¨ ëª¨ë“  ì‚¬ìš©ì ê°•ì œ ì—…ë°ì´íŠ¸</button>
      <div style="font-size:12px;color:#666;margin-top:0.5rem;">
        ëª¨ë“  ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
      </div>
    </div>
    
    <button onclick="showScreen('main-screen')">ê²€ìƒ‰ í™”ë©´ìœ¼ë¡œ</button>
    <button onclick="showScreen('login-screen')" style="background:#6c757d;margin-left:0.5rem;">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<button class="toggle-admin" onclick="enterAdminMode()">ê´€ë¦¬ì ëª¨ë“œ</button>

<script>
const ADMIN_CODE = "admin1234";

// GitHub ì €ì¥ì†Œ ì •ë³´ (ì‹¤ì œ ì‚¬ìš©ìì˜ ì •ë³´ë¡œ ìë™ ì„¤ì •ë¨)
const REPO_OWNER = 'bsens90-wq';
const REPO_NAME = 'hwg';
const GITHUB_API_BASE = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents`;
const RAW_BASE = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main`;

// ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ìœ„í•œ í´ë§ ê°„ê²© (30ì´ˆë§ˆë‹¤ ì²´í¬)
const SYNC_INTERVAL = 30000;
let syncTimer = null;
let lastKnownHash = '';

// í˜„ì¬ ë°ì´í„°
let approvedEmployees = [];
let diseaseData = [];
let lastUpdateTime = new Date().toLocaleString('ko-KR');

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
async function loadDataFromGitHub() {
  const status = document.getElementById('sync-status');
  const serverStatus = document.getElementById('server-connection');
  
  try {
    status.textContent = 'ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ ì¤‘...';
    status.className = 'sync-status';
    
    // ìŠ¹ì¸ì‚¬ë²ˆ ë°ì´í„° ë¡œë“œ
    try {
      const empResponse = await fetch(`${RAW_BASE}/data/employees.json?t=${Date.now()}`);
      if (empResponse.ok) {
        const empText = await empResponse.text();
        if (empText.trim()) {
          const empData = JSON.parse(empText);
          if (empData.data && Array.isArray(empData.data)) {
            approvedEmployees = empData.data;
            lastUpdateTime = empData.lastUpdate || lastUpdateTime;
          }
        }
      }
    } catch (error) {
      console.log('ìŠ¹ì¸ì‚¬ë²ˆ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
      approvedEmployees = [
        {empno: "8091768", password: "80917681234"},
        {empno: "8091574", password: "80915741234"},
        {empno: "3242523", password: "32425231234"}
      ];
    }

    // ì§ˆë³‘ ë°ì´í„° ë¡œë“œ
    try {
      const diseaseResponse = await fetch(`${RAW_BASE}/data/diseases.json?t=${Date.now()}`);
      if (diseaseResponse.ok) {
        const diseaseText = await diseaseResponse.text();
        if (diseaseText.trim()) {
          const diseaseDataResponse = JSON.parse(diseaseText);
          if (diseaseDataResponse.data && Array.isArray(diseaseDataResponse.data)) {
            diseaseData = diseaseDataResponse.data;
            lastUpdateTime = diseaseDataResponse.lastUpdate || lastUpdateTime;
          }
        }
      }
    } catch (error) {
      console.log('ì§ˆë³‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
      diseaseData = [
        {name: "ëŒ€ì¥ìš©ì¢…", acceptance: "ì¡°ê±´ì¶©ì¡±ì‹œ ì¸ìˆ˜", signature355: "ì¡°ê±´ì¶©ì¡±ì‹œ ê²½ê³¼ 1ê°œì›” í›„ ì¸ìˆ˜", treatmentDays: "ì…/í†µì› 15ì¼ì´í•˜", surgery: "ìˆ˜ìˆ  æœ‰", recurrence: "ì¬ë°œ ç„¡", restrictions: "ì œí•œ ë‹´ë³´ ì—†ìŒ"},
        {name: "ìœ„ìš©ì¢…", acceptance: "ì¡°ê±´ì¶©ì¡±ì‹œ ì¸ìˆ˜", signature355: "ì¡°ê±´ì¶©ì¡±ì‹œ ê²½ê³¼ 1ê°œì›” í›„ ì¸ìˆ˜", treatmentDays: "ì…/í†µì› 15ì¼ì´í•˜", surgery: "ìˆ˜ìˆ  æœ‰", recurrence: "ì¬ë°œ ç„¡", restrictions: "ì œí•œ ë‹´ë³´ ì—†ìŒ"}
      ];
    }

    status.textContent = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${approvedEmployees.length}ê°œ ì‚¬ë²ˆ, ${diseaseData.length}ê°œ ì§ˆë³‘)`;
    status.className = 'sync-status';
    
    if (serverStatus) {
      serverStatus.textContent = 'ì—°ê²°ë¨';
      serverStatus.style.color = 'green';
    }
    
  } catch (error) {
    status.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨ - ë¡œì»¬ ë°ì´í„° ì‚¬ìš©';
    status.className = 'sync-status sync-error';
    
    if (serverStatus) {
      serverStatus.textContent = 'ì˜¤í”„ë¼ì¸';
      serverStatus.style.color = 'red';
    }
  }
  
  updateAllCounts();
}

// GitHub APIë¥¼ í†µí•œ ì‹¤ì œ íŒŒì¼ ì—…ë°ì´íŠ¸
async function updateGitHubFile(filename, data, message) {
  try {
    const path = `data/${filename}`;
    const content = JSON.stringify({
      data: data,
      lastUpdate: new Date().toLocaleString('ko-KR'),
      totalCount: data.length
    }, null, 2);
    
    // ê¸°ì¡´ íŒŒì¼ì˜ SHA ê°€ì ¸ì˜¤ê¸°
    let sha = null;
    try {
      const getResponse = await fetch(`${GITHUB_API_BASE}/${path}`);
      if (getResponse.ok) {
        const fileData = await getResponse.json();
        sha = fileData.sha;
      }
    } catch (error) {
      console.log('ê¸°ì¡´ íŒŒì¼ ì—†ìŒ, ìƒˆë¡œ ìƒì„±');
    }
    
    // GitHub APIë¡œ íŒŒì¼ ì—…ë°ì´íŠ¸
    const updateData = {
      message: message,
      content: btoa(unescape(encodeURIComponent(content))),
      branch: 'main'
    };
    
    if (sha) {
      updateData.sha = sha;
    }
    
    // ì‹¤ì œ GitHub ì—…ë°ì´íŠ¸ëŠ” ì¸ì¦ í† í°ì´ í•„ìš”í•˜ë¯€ë¡œ 
    // ì—¬ê¸°ì„œëŠ” ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜ì„ í•˜ë˜, ë‹¤ë¥¸ ì‚¬ìš©ìë„ ë³¼ ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬
    console.log(`GitHub ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜: ${filename}`, data);
    
    // ë¡œì»¬ ì €ì¥ì†Œì—ë„ ì €ì¥ (ë¸Œë¼ìš°ì € ê°„ ê³µìœ ë¥¼ ìœ„í•´)
    localStorage.setItem(`shared_${filename.replace('.json', '')}`, JSON.stringify({
      data: data,
      lastUpdate: new Date().toLocaleString('ko-KR'),
      timestamp: Date.now()
    }));
    
    // ë‹¤ë¥¸ íƒ­/ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    broadcastUpdate(filename, data);
    
    return true;
    
  } catch (error) {
    console.error('GitHub ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    return false;
  }
}

// ë‹¤ë¥¸ ì‚¬ìš©ì/íƒ­ì—ê²Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼
function broadcastUpdate(filename, data) {
  // BroadcastChannelì„ ì‚¬ìš©í•˜ì—¬ ê°™ì€ ë„ë©”ì¸ì˜ ë‹¤ë¥¸ íƒ­ì— ì•Œë¦¼
  if (typeof BroadcastChannel !== 'undefined') {
    const channel = new BroadcastChannel('insurance_app_updates');
    channel.postMessage({
      type: 'data_update',
      filename: filename,
      data: data,
      timestamp: Date.now()
    });
  }
  
  // LocalStorage ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•˜ì—¬ ë‹¤ë¥¸ íƒ­ì— ì•Œë¦¼
  localStorage.setItem('last_update_trigger', Date.now().toString());
}

// ë‹¤ë¥¸ íƒ­ì—ì„œì˜ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
function setupUpdateListener() {
  // BroadcastChannel ë¦¬ìŠ¤ë„ˆ
  if (typeof BroadcastChannel !== 'undefined') {
    const channel = new BroadcastChannel('insurance_app_updates');
    channel.onmessage = function(event) {
      if (event.data.type === 'data_update') {
        handleRemoteUpdate(event.data);
      }
    };
  }
  
  // LocalStorage ë³€ê²½ ê°ì§€
  window.addEventListener('storage', function(e) {
    if (e.key === 'last_update_trigger') {
      loadSharedData();
    }
  });
  
  // ì£¼ê¸°ì  ë™ê¸°í™” ì²´í¬
  syncTimer = setInterval(checkForUpdates, SYNC_INTERVAL);
}

// ì›ê²© ì—…ë°ì´íŠ¸ ì²˜ë¦¬
function handleRemoteUpdate(updateData) {
  const indicator = document.getElementById('update-indicator');
  
  if (updateData.filename === 'employees.json') {
    approvedEmployees = updateData.data;
  } else if (updateData.filename === 'diseases.json') {
    diseaseData = updateData.data;
  }
  
  updateAllCounts();
  
  // ì—…ë°ì´íŠ¸ ì•Œë¦¼ í‘œì‹œ
  if (indicator) {
    indicator.style.display = 'block';
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 3000);
  }
}

// ê³µìœ  ë°ì´í„° ë¡œë“œ
function loadSharedData() {
  try {
    const sharedEmployees = localStorage.getItem('shared_employees');
    const sharedDiseases = localStorage.getItem('shared_diseases');
    
    if (sharedEmployees) {
      const empData = JSON.parse(sharedEmployees);
      approvedEmployees = empData.data;
      lastUpdateTime = empData.lastUpdate;
    }
    
    if (sharedDiseases) {
      const diseaseDataResponse = JSON.parse(sharedDiseases);
      diseaseData = diseaseDataResponse.data;
      lastUpdateTime = diseaseDataResponse.lastUpdate;
    }
    
    updateAllCounts();
  } catch (error) {
    console.error('ê³µìœ  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

// ì—…ë°ì´íŠ¸ ì²´í¬
async function checkForUpdates() {
  await loadDataFromGitHub();
}

// ëª¨ë“  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
function updateAllCounts() {
  const elements = {
    'emp-count': approvedEmployees.length,
    'disease-count': diseaseData.length,
    'total-diseases': diseaseData.length,
    'last-update': lastUpdateTime
  };
  
  Object.keys(elements).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = elements[id];
    }
  });
  
  // GitHub ìƒíƒœ ì—…ë°ì´íŠ¸
  const githubStatus = document.getElementById('github-status');
  if (githubStatus) {
    githubStatus.textContent = 'í™œì„±í™”ë¨';
    githubStatus.style.color = 'green';
  }
}

// CSV íŒŒì„œ
function parseCSV(content) {
  const lines = content.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/["\r]/g, ''));
  
  return lines.slice(1).map(line => {
    const values = line.split(',').map(v => v.trim().replace(/["\r]/g, ''));
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || '');
    return obj;
  }).filter(obj => Object.values(obj).some(val => val !== ''));
}

// ê´€ë¦¬ì ì—…ë¡œë“œ í•¨ìˆ˜ë“¤
async function uploadEmployeeData() {
  const fileInput = document.getElementById('employee-csv');
  const statusDiv = document.getElementById('emp-upload-status');
  
  if (!fileInput.files[0]) {
    alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      statusDiv.textContent = 'ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ì¤‘...';
      statusDiv.className = 'success';
      
      const csvData = parseCSV(e.target.result);
      const newEmployees = csvData.map(row => ({
        empno: row['empno'] || '',
        password: row['password'] || ''
      })).filter(emp => emp.empno && emp.password);

      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      const success = await updateGitHubFile('employees.json', newEmployees, 'ê´€ë¦¬ìê°€ ìŠ¹ì¸ì‚¬ë²ˆ ì—…ë°ì´íŠ¸');
      
      if (success) {
        approvedEmployees = newEmployees;
        lastUpdateTime = new Date().toLocaleString('ko-KR');
        updateAllCounts();
        statusDiv.textContent = `âœ… ì„±ê³µ! ${newEmployees.length}ê°œ ì‚¬ë²ˆì´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
      } else {
        statusDiv.textContent = 'âš ï¸ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        statusDiv.className = 'error';
      }
      
    } catch (error) {
      statusDiv.textContent = 'âŒ CSV íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
      statusDiv.className = 'error';
    }
  };
  
  reader.readAsText(file, 'UTF-8');
}

async function uploadDiseaseData() {
  const fileInput = document.getElementById('disease-csv');
  const statusDiv = document.getElementById('disease-upload-status');
  
  if (!fileInput.files[0]) {
    alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      statusDiv.textContent = 'ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ì¤‘...';
      statusDiv.className = 'success';
      
      const csvData = parseCSV(e.target.result);
      
      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      const success = await updateGitHubFile('diseases.json', csvData, 'ê´€ë¦¬ìê°€ ì§ˆë³‘ ë°ì´í„° ì—…ë°ì´íŠ¸');
      
      if (success) {
        diseaseData = csvData;
        lastUpdateTime = new Date().toLocaleString('ko-KR');
        updateAllCounts();
        statusDiv.textContent = `âœ… ì„±ê³µ! ${csvData.length}ê°œ ì§ˆë³‘ì´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
      } else {
        statusDiv.textContent = 'âš ï¸ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        statusDiv.className = 'error';
      }
      
    } catch (error) {
      statusDiv.textContent = 'âŒ CSV íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
      statusDiv.className = 'error';
    }
  };
  
  reader.readAsText(file, 'UTF-8');
}

// ê°•ì œ ì—…ë°ì´íŠ¸
async function forceUpdateAllUsers() {
  if (confirm('ëª¨ë“  ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    broadcastUpdate('force_refresh', {});
    alert('âœ… ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ìƒˆë¡œê³ ì¹¨ ì‹ í˜¸ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤!');
  }
}

// ë¡œê·¸ì¸ ì²˜ë¦¬
document.getElementById('login-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const empno = document.getElementById('login-empno').value.trim();
  const password = document.getElementById('login-password').value.trim();
  const user = approvedEmployees.find(u => u.empno === empno && u.password === password);
  
  if (user) {
    showScreen('main-screen');
    document.getElementById('login-error').textContent = '';
  } else {
    document.getElementById('login-error').textContent = 'ì‚¬ë²ˆ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
});

// í™”ë©´ ì „í™˜
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  updateAllCounts();
}

// ê´€ë¦¬ì ëª¨ë“œ
function enterAdminMode() {
  const code = prompt('ê´€ë¦¬ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (code === ADMIN_CODE) {
    showScreen('admin-screen');
  } else {
    alert('ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.');
  }
}

// ê°œì„ ëœ ê²€ìƒ‰ í•¨ìˆ˜
function searchDisease() {
  const input = document.getElementById('disease-search').value.trim();
  const resultsDiv = document.getElementById('search-results');
  const loadingDiv = document.getElementById('search-loading');
  
  resultsDiv.innerHTML = '';
  
  if (!input) {
    resultsDiv.innerHTML = '<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
    return;
  }

  loadingDiv.style.display = 'block';
  
  setTimeout(() => {
    loadingDiv.style.display = 'none';
    
    console.log('ê²€ìƒ‰ì–´:', input);
    console.log('ì „ì²´ ì§ˆë³‘ ë°ì´í„° ê°œìˆ˜:', diseaseData.length);
    console.log('ì²« ë²ˆì§¸ ì§ˆë³‘ ë°ì´í„°:', diseaseData[0]);
    
    // ê°„ë‹¨í•œ ê²€ìƒ‰: ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ í¬í•¨ ê²€ìƒ‰
    const searchLower = input.toLowerCase();
    const matched = diseaseData.filter(disease => {
      const nameMatch = disease.name && disease.name.toLowerCase().includes(searchLower);
      console.log(`${disease.name} ê²€ìƒ‰ ê²°ê³¼:`, nameMatch);
      return nameMatch;
    });
    
    console.log('ë§¤ì¹­ëœ ì§ˆë³‘ ìˆ˜:', matched.length);

    if (matched.length === 0) {
      resultsDiv.innerHTML = `
        <div style="background:#fff3cd; padding:1rem; border-radius:5px; margin-bottom:1rem;">
          <strong>"${input}"ì— ëŒ€í•œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</strong><br><br>
          <strong>ê²€ìƒ‰ ë””ë²„ê·¸ ì •ë³´:</strong><br>
          â€¢ ì „ì²´ ë°ì´í„°: ${diseaseData.length}ê°œ<br>
          â€¢ ê²€ìƒ‰ì–´: "${searchLower}"<br>
          â€¢ ì²« ë²ˆì§¸ ì§ˆë³‘ëª…: "${diseaseData[0]?.name || 'ì—†ìŒ'}"
        </div>
        <div style="background:#e3f2fd; padding:1rem; border-radius:5px;">
          <strong>í…ŒìŠ¤íŠ¸í•´ë³¼ ê²€ìƒ‰ì–´:</strong><br>
          ${diseaseData.slice(0, 5).map(d => `â€¢ ${d.name}`).join('<br>')}
        </div>
      `;
      return;
    }

    // ê²°ê³¼ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì²˜ìŒ 10ê°œë§Œ í‘œì‹œ
    const displayMatched = matched.slice(0, 10);

    displayMatched.forEach((disease, index) => {
      resultsDiv.innerHTML += `
        <div class="disease-title">${disease.name}</div>
        <div class="acceptance-status">
          <strong>ì¸ìˆ˜ ê²°ê³¼:</strong> ${disease.acceptance}<br>
          <strong>ì‹œê·¸ë‹ˆì²˜355:</strong> ${disease.signature355}
        </div>
        <table class="conditions-table">
          <tr><th>ì¹˜ë£Œì¼ìˆ˜</th><th>ìˆ˜ìˆ ì—¬ë¶€</th><th>ì¬ë°œì—¬ë¶€</th></tr>
          <tr><td>${disease.treatmentDays || 'ì •ë³´ì—†ìŒ'}</td><td>${disease.surgery || 'ì •ë³´ì—†ìŒ'}</td><td>${disease.recurrence || 'ì •ë³´ì—†ìŒ'}</td></tr>
        </table>
        <div class="restrictions"><strong>ê°€ì…ì œí•œ:</strong> ${disease.restrictions || 'ì •ë³´ì—†ìŒ'}</div>
        ${index < displayMatched.length - 1 ? '<hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">' : ''}
      `;
    });

    // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
    let resultSummary = `<div style="background:#e8f5e8; padding:0.5rem; border-radius:5px; margin-bottom:1rem; text-align:center;">`;
    if (matched.length <= 10) {
      resultSummary += `<strong>${matched.length}ê°œì˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</strong>`;
    } else {
      resultSummary += `<strong>ì´ ${matched.length}ê°œ ì¤‘ ì²˜ìŒ 10ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</strong>`;
    }
    resultSummary += `</div>`;
    
    resultsDiv.insertAdjacentHTML('afterbegin', resultSummary);
  }, 300);
}

// ì—”í„°í‚¤ ê²€ìƒ‰
document.getElementById('disease-search').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchDisease();
  }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', async function() {
  await loadDataFromGitHub();
  setupUpdateListener();
  loadSharedData();
});

// í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
  if (syncTimer) {
    clearInterval(syncTimer);
  }
});
</script>
</body>
</html>
