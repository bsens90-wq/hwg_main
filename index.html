<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìœ ë³‘ì ì¸ìˆ˜ê°€ì´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekSDsnbTsiJjqsIDsnbTrk5wiLCJzaG9ydF9uYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekyIsInN0YXJ0X3VybCI6Ii4vaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjZmY3ZjAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGY5ZmEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yV3lCM2FXUjBhRDBpTWpRd0lpQm9aV2xuYUhROUlqSTBNQ0lnZG1sbGQwSnZlRDBpTUNBd0lESTBNQ0F5TkRBaUlHWnBiR3c5SWlObVpqZG1NREFpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaaTh5TURBd0wzTjJaeUkrUEdOcGNtTnNaU0JqZUQwaU1USTBJaUJqZVQwaU1USTBJaUJ5UFNJeE1ERWlJR1pwYkd3OUlpTm1aalk0REFBMU9VNGlMejRBUEhCaGRHZ2daRDBpVFRFME9TQXRNRGxDTGpBeFNIazNOem93TlFGc05qZ3VPRGd1TURNMUxqQXhObDBpSUdacGJHdzlJaU5tWmpkbU1EQWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" />
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.reset{
      background:#dc3545;
      margin-top:8px;
    }
    button.reset:hover{background:#c82333}
    button.debug{
      background:#17a2b8;
      margin-bottom:8px;
    }
    button.debug:hover{background:#138496}
    button.logout{
      background:#28a745;
      margin-bottom:8px;
    }
    button.logout:hover{background:#218838}
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#137333; font-size:13px}
    .debug{color:#17a2b8; font-size:12px; margin-top:.5rem; background:#f8f9fa; padding:8px; border-radius:5px; font-family:monospace; white-space:pre-wrap; max-height:200px; overflow-y:auto;}
    .container-narrow{max-width:760px}
    .results{margin-top:1rem}
    .result-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:12px;
    }
    .result-title{
      font-size:18px;
      font-weight:700;
      color:#222;
      margin-bottom:6px;
    }
    .result-sub{color:#444; margin:.25rem 0 .5rem 0}
    .info-table{
      width:100%;
      border-collapse:collapse;
      margin-top:.25rem;
      font-size:14px;
    }
    .info-table th,.info-table td{
      border:1px solid var(--border);
      padding:8px;
      text-align:center;
      white-space:nowrap;
    }
    .restrictions{
      margin-top:.5rem;
      padding:.5rem .75rem;
      background:#fafafa;
      border:1px dashed var(--border);
      border-radius:10px;
      font-size:14px;
      white-space:pre-line;
    }
    .meta{
      margin-top:.5rem;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .install-prompt{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--hanwha);
      color:white;
      padding:12px 20px;
      border-radius:25px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      display:none;
      z-index:1000;
      cursor:pointer;
      font-weight:700;
    }
    .admin-btn{
      position:fixed;
      bottom:10px;
      right:10px;
      width:40px;
      height:40px;
      background:rgba(108,117,125,0.8);
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:12px;
      font-weight:700;
      border:none;
    }
    .log-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      margin-bottom:8px;
      font-size:14px;
    }
    .log-header{
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:4px;
    }
    .log-time{
      color:var(--muted);
      font-size:12px;
    }
    .log-search{
      background:#f0f8ff;
      padding:4px 8px;
      border-radius:5px;
      margin-top:4px;
      font-family:monospace;
    }
    .user-info{
      position:fixed;
      top:10px;
      right:10px;
      background:rgba(255,127,0,0.1);
      padding:8px 12px;
      border-radius:20px;
      font-size:12px;
      color:var(--hanwha);
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .user-info button{
      padding:4px 8px;
      font-size:11px;
      margin:0;
      width:auto;
      min-width:50px;
    }
    .loading{
      display:inline-block;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
  </style>
</head>
<body>
 <!-- ë¡œê·¸ì¸ í™”ë©´ -->
<section id="loginScreen" class="screen">
  <div class="app-title">í•œí™”ì†ë³´ ìœ ë³‘ì ì¸ìˆ˜ ê°€ì´ë“œ</div>
  <div class="card">
    <h2>ë¡œê·¸ì¸</h2>
    <div class="row">
      <input id="empno" type="text" placeholder="ì½”ë“œ ì…ë ¥" autocomplete="username" />
    </div>
    <div class="row">
      <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" />
      <div class="hint">ì½”ë“œëŠ” ì‚¬ì „ ìŠ¹ì¸ëœ ê¸°ê´€ì— ë¶€ì—¬ë©ë‹ˆë‹¤.</div>
    </div>
    <button id="loginBtn">ë¡œê·¸ì¸</button>
    <button id="installBtn" class="secondary">í™ˆí™”ë©´ì— ì¶”ê°€</button>
    <div id="loginMsg" class="error" role="alert" aria-live="polite"></div>
    <div class="meta" id="empMeta"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
  </div>
</section>

<!-- ê²€ìƒ‰ í™”ë©´ -->
<section id="searchScreen" class="screen" style="display:none;">
  <div class="user-info" id="userInfo">
    <span id="userText"></span>
    <button id="logoutBtn" class="logout">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <div class="app-title">í•œí™”ì†ë³´ ìœ ë³‘ì ì¸ìˆ˜ ê°€ì´ë“œ</div>
  <div class="card container-narrow">
    <h2 style="margin-bottom:.5rem;">ì§ˆë³‘ëª… ê²€ìƒ‰</h2>
    <div class="row">
      <input id="searchInput" type="text" placeholder="ì˜ˆì‹œ: ìš©ì¢…, ê³¨ì ˆ, ë‹¹ë‡¨ ë“±" />
    </div>
    <button id="searchBtn" title="ê²€ìƒ‰">ê²€ìƒ‰</button>
    <div class="results" id="results"></div>
    <div class="meta" id="disMeta"></div>
    <div class="debug" id="debugInfo" style="display:none;"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
  </div>
</section>

  <!-- ê´€ë¦¬ì ë¡œê·¸ í™”ë©´ -->
  <section id="adminScreen" class="screen" style="display:none;">
    <div class="app-title">ê´€ë¦¬ì ë¡œê·¸ ì¡°íšŒ</div>
    <div class="card container-narrow">
      <h2>ì‚¬ìš©ì í™œë™ ë¡œê·¸</h2>
      <div class="row">
        <input id="adminPassword" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." />
      </div>
      <button id="loadLogsBtn">ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="testGitHubBtn" class="debug">GitHub ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <button id="resetLoginBtn" class="reset">ëª¨ë“  ì‚¬ìš©ì ë¡œê·¸ì¸ ì´ˆê¸°í™”</button>
      <button id="backToSearchBtn" class="secondary">ê²€ìƒ‰í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <div id="adminMsg" class="error"></div>
      <div class="debug" id="githubDebug"></div>
      <div class="meta" id="logStats"></div>
      <div id="logResults" class="results"></div>
    </div>
  </section>

  <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
  <div id="installPrompt" class="install-prompt">í™ˆí™”ë©´ì— ì¶”ê°€í•˜ê¸°</div>

  <!-- ê´€ë¦¬ì ë²„íŠ¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
  <button id="adminBtn" class="admin-btn" title="ê´€ë¦¬ì" style="display:none; visibility:hidden;">Admin</button>

<script>
// ì „ì—­ ë³€ìˆ˜
let employees = [];
let diseases = [];
let currentUser = null;
let userLogs = [];

// PWA ì„¤ì¹˜ ê´€ë ¨
let deferredPrompt;

// ë°ì´í„° URL
const EMP_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/employees.json";
const DIS_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/diseases.json";

// GitHub ë¡œê·¸ ì„¤ì •
const GITHUB_CONFIG = {
  owner: 'bsens90-wq',
  repo: 'patient-guide-logs',
  path: 'logs/user_logs.json',
  token: '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',
  branch: 'main'
};

// ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
function showDebug(message, isError = false) {
  const debugElement = document.getElementById('debugInfo');
  const githubDebugElement = document.getElementById('githubDebug');
  
  const timestamp = new Date().toLocaleTimeString();
  const debugMsg = `[${timestamp}] ${message}\n`;
  
  if (debugElement) {
    debugElement.style.display = 'block';
    debugElement.textContent += debugMsg;
    debugElement.scrollTop = debugElement.scrollHeight;
  }
  if (githubDebugElement) {
    githubDebugElement.textContent += debugMsg;
    githubDebugElement.scrollTop = githubDebugElement.scrollHeight;
  }
  
  console.log(isError ? 'ERROR:' : 'DEBUG:', message);
}

// GitHub ì—°ê²° í…ŒìŠ¤íŠ¸
async function testGitHubConnection() {
  const msg = document.getElementById("adminMsg");
  const password = document.getElementById("adminPassword").value.trim();
  
  if(password !== "admin123") {
    msg.textContent = "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }
  
  msg.textContent = "";
  showDebug("=== GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===");
  
  // í† í° ìƒíƒœ í™•ì¸
  showDebug(`í† í° ê¸¸ì´: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 'ì—†ìŒ'}`);
  showDebug(`í† í° ì‹œì‘: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.substring(0, 10) + '...' : 'ì—†ìŒ'}`);
  
  if (!GITHUB_CONFIG.token) {
    showDebug("GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", true);
    msg.textContent = "í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    return;
  }

  try {
    // 1. ê¸°ë³¸ GitHub API ì‘ë‹µ í…ŒìŠ¤íŠ¸
    showDebug("1. GitHub API ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸...");
    const basicResponse = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    showDebug(`ê¸°ë³¸ API ì‘ë‹µ: ${basicResponse.status} ${basicResponse.statusText}`);
    
    if (basicResponse.ok) {
      const userData = await basicResponse.json();
      showDebug(`ì¸ì¦ëœ ì‚¬ìš©ì: ${userData.login}`);
    } else {
      const errorData = await basicResponse.json();
      showDebug(`ê¸°ë³¸ API ì˜¤ë¥˜: ${JSON.stringify(errorData)}`, true);
    }

    // 2. ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
    showDebug("2. ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ í…ŒìŠ¤íŠ¸...");
    const repoUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
    showDebug(`ë¦¬í¬ì§€í† ë¦¬ URL: ${repoUrl}`);
    
    const repoResponse = await fetch(repoUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`ë¦¬í¬ì§€í† ë¦¬ ì‘ë‹µ: ${repoResponse.status} ${repoResponse.statusText}`);

    if (!repoResponse.ok) {
      const errorText = await repoResponse.text();
      showDebug(`ë¦¬í¬ì§€í† ë¦¬ ì˜¤ë¥˜ ë‚´ìš©: ${errorText}`, true);
      throw new Error(`ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ ì‹¤íŒ¨: ${repoResponse.status}`);
    }

    const repoData = await repoResponse.json();
    showDebug(`ë¦¬í¬ì§€í† ë¦¬ëª…: ${repoData.name}, ê³µê°œì—¬ë¶€: ${repoData.private ? 'Private' : 'Public'}`);

    // 3. íŒŒì¼ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
    showDebug("3. ë¡œê·¸ íŒŒì¼ ì ‘ê·¼ í…ŒìŠ¤íŠ¸...");
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    showDebug(`íŒŒì¼ URL: ${fileUrl}`);
    
    const fileResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`íŒŒì¼ ì ‘ê·¼ ì‘ë‹µ: ${fileResponse.status} ${fileResponse.statusText}`);

    if (fileResponse.ok) {
      const fileData = await fileResponse.json();
      showDebug(`íŒŒì¼ ì¡´ì¬í•¨: ${GITHUB_CONFIG.path}`);
      showDebug(`íŒŒì¼ í¬ê¸°: ${fileData.size} bytes, SHA: ${fileData.sha}`);
      
      try {
        const content = atob(fileData.content);
        const logs = JSON.parse(content);
        showDebug(`í˜„ì¬ ë¡œê·¸ ê°œìˆ˜: ${logs.length}ê°œ`);
        
        if (logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          showDebug(`ìµœê·¼ ë¡œê·¸: ${lastLog.date} - ${lastLog.empno} - ${lastLog.action}`);
        }
      } catch (parseError) {
        showDebug(`íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${parseError.message}`, true);
      }
      
    } else if (fileResponse.status === 404) {
      showDebug("íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ì²« ë¡œê·¸ ì €ì¥ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.");
      
      // 4. íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸
      showDebug("4. íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸...");
      const testLog = [{
        empno: "TEST",
        action: "test_connection",
        details: "GitHub ì—°ê²° í…ŒìŠ¤íŠ¸",
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('ko-KR')
      }];
      
      const createResponse = await fetch(fileUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ - ë¡œê·¸ íŒŒì¼ ìƒì„±',
          content: btoa(JSON.stringify(testLog, null, 2)),
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (createResponse.ok) {
        showDebug("í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ì„±ê³µ!");
      } else {
        const createErrorText = await createResponse.text();
        showDebug(`íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ${createResponse.status} - ${createErrorText}`, true);
      }
      
    } else {
      const errorText = await fileResponse.text();
      showDebug(`íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜: ${fileResponse.status} - ${errorText}`, true);
    }

    showDebug("=== GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===");
    msg.innerHTML = '<span class="success">GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ë””ë²„ê·¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span>';

  } catch (error) {
    showDebug(`GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, true);
    msg.textContent = `GitHub ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
  }
}

// ìë™ ë¡œê·¸ì¸ ì²´í¬
function checkAutoLogin() {
  const savedUser = localStorage.getItem('hwg_current_user');
  if (savedUser) {
    currentUser = savedUser;
    showLoginSuccess();
    showDebug(`ìë™ ë¡œê·¸ì¸: ${currentUser}`);
  }
}

// ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
function showLoginSuccess() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("searchScreen").style.display = "flex";
  document.getElementById("userText").textContent = `ë¡œê·¸ì¸: ${currentUser}`;
  document.getElementById("searchInput").focus();
}

// ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
function logout() {
  if (currentUser) {
    // ë¡œê·¸ì•„ì›ƒ ë¡œê·¸ ê¸°ë¡
    saveLogToGitHub(currentUser, 'logout', 'ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ');
    
    // ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™”
    localStorage.removeItem('hwg_current_user');
    currentUser = null;
    
    // í™”ë©´ ì „í™˜
    document.getElementById("searchScreen").style.display = "none";
    document.getElementById("adminScreen").style.display = "none";
    document.getElementById("loginScreen").style.display = "flex";
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById("empno").value = "";
    document.getElementById("password").value = "";
    document.getElementById("searchInput").value = "";
    document.getElementById("results").innerHTML = "";
    
    showDebug("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
  }
}

// GitHub APIë¥¼ í†µí•œ ë¡œê·¸ ì¶”ê°€ (ì¤‘ì•™ ë¡œê·¸ ê´€ë¦¬)
async function appendLogToGitHub(newLog) {
  try {
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    
    // í˜„ì¬ íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const getResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    let existingLogs = [];
    let sha = null;

    if (getResponse.ok) {
      const data = await getResponse.json();
      sha = data.sha;
      const content = atob(data.content);
      existingLogs = JSON.parse(content);
      showDebug(`ê¸°ì¡´ ë¡œê·¸ ${existingLogs.length}ê°œ ë°œê²¬`);
    } else if (getResponse.status === 404) {
      showDebug("íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.");
    } else {
      throw new Error(`íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${getResponse.status}`);
    }

    // ìƒˆ ë¡œê·¸ ì¶”ê°€
    existingLogs.push(newLog);
    
    // ìµœëŒ€ 1000ê°œ ë¡œê·¸ë§Œ ìœ ì§€
    if (existingLogs.length > 1000) {
      existingLogs = existingLogs.slice(-1000);
    }

    const newContent = btoa(JSON.stringify(existingLogs, null, 2));

    // GitHubì— ì—…ë°ì´íŠ¸
    const updatePayload = {
      message: `Add log: ${newLog.action} by ${newLog.empno}`,
      content: newContent,
      branch: GITHUB_CONFIG.branch
    };
    
    if (sha) {
      updatePayload.sha = sha;
    }

    const updateResponse = await fetch(fileUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatePayload)
    });

    if (!updateResponse.ok) {
      const errorText = await updateResponse.text();
      throw new Error(`GitHub ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateResponse.status} - ${errorText}`);
    }

    showDebug(`GitHub ë¡œê·¸ ì €ì¥ ì„±ê³µ: ${newLog.action} by ${newLog.empno}`);

  } catch (error) {
    showDebug(`GitHub ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜: ${error.message}`, true);
    
    // GitHub ì €ì¥ ì‹¤íŒ¨ì‹œ ë¡œì»¬ì— ë°±ì—…
    const localLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    localLogs.push(newLog);
    if (localLogs.length > 100) {
      localLogs.splice(0, localLogs.length - 100);
    }
    localStorage.setItem('backup_logs', JSON.stringify(localLogs));
    showDebug("ë¡œì»¬ ë°±ì—…ì— ì €ì¥ë¨");
  }
}

// ì¤‘ì•™ ë¡œê·¸ ì €ì¥ í•¨ìˆ˜ (GitHub ì—°ë™)
async function saveLogToGitHub(empno, action, details = '') {
  const newLog = {
    empno,
    action,
    details,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleString('ko-KR'),
    userAgent: navigator.userAgent.substring(0, 100) // ë¸Œë¼ìš°ì € ì •ë³´ (ì œí•œì )
  };
  
  // ë¹„ë™ê¸°ë¡œ GitHubì— ì €ì¥
  appendLogToGitHub(newLog);
}

// GitHubì—ì„œ ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadLogsFromGitHub() {
  // GitHub ì—°ë™ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° ë¡œì»¬ ë°±ì—…ë§Œ ì‚¬ìš©
  if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token) {
    showDebug("GitHub ì—°ë™ì´ ë¹„í™œì„±í™”ë¨. ë¡œì»¬ ë°±ì—… ì‚¬ìš©");
    const backupLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    if (backupLogs.length > 0) {
      showDebug(`ë¡œì»¬ ë°±ì—…ì—ì„œ ${backupLogs.length}ê°œ ë¡œê·¸ ì‚¬ìš©`);
    }
    return backupLogs;
  }

  try {
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      if (response.status === 404) {
        showDebug("ë¡œê·¸ íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return [];
      }
      throw new Error(`GitHub API ì˜¤ë¥˜: ${response.status}`);
    }

    const data = await response.json();
    const content = atob(data.content);
    const logs = JSON.parse(content);
    showDebug(`GitHubì—ì„œ ${logs.length}ê°œ ë¡œê·¸ ë¶ˆëŸ¬ì˜´`);
    return logs;
  } catch (error) {
    showDebug(`GitHub ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`, true);
    
    // GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ì‹œ ë¡œì»¬ ë°±ì—… ì‚¬ìš©
    const backupLogs = JSON.parse(localStorage.getItem('backup_logs') || '[]');
    if (backupLogs.length > 0) {
      showDebug(`ë¡œì»¬ ë°±ì—…ì—ì„œ ${backupLogs.length}ê°œ ë¡œê·¸ ì‚¬ìš©`);
    }
    return backupLogs;
  }
}

// ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë©´ì„œ GitHub ì—°ë™ ì¶”ê°€)
function saveLog(empno, action, details = '') {
  saveLogToGitHub(empno, action, details);
}

// ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™” (ì‹¤ì œ ì‘ë™í•˜ë„ë¡ ìˆ˜ì •)
async function resetAllLogins() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  
  if(password !== "admin123") {
    msg.textContent = "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }

  try {
    // í˜„ì¬ ëª¨ë“  ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™”
    localStorage.removeItem('hwg_current_user');
    
    // í˜„ì¬ ì‚¬ìš©ìë„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    if (currentUser) {
      const previousUser = currentUser;
      currentUser = null;
      
      // í™”ë©´ì„ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
      document.getElementById("searchScreen").style.display = "none";
      document.getElementById("adminScreen").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById("empno").value = "";
      document.getElementById("password").value = "";
      
      // ì´ˆê¸°í™” ë¡œê·¸ ê¸°ë¡
      await saveLogToGitHub('ADMIN', 'reset_all_logins', `All user login states reset by admin. Previous user: ${previousUser}`);
      
      showDebug(`ê´€ë¦¬ìì— ì˜í•œ ì „ì²´ ë¡œê·¸ì¸ ì´ˆê¸°í™” ì™„ë£Œ. ì´ì „ ì‚¬ìš©ì: ${previousUser}`);
    } else {
      // ì´ˆê¸°í™” ë¡œê·¸ ê¸°ë¡
      await saveLogToGitHub('ADMIN', 'reset_all_logins', 'All user login states reset by admin');
      showDebug("ê´€ë¦¬ìì— ì˜í•œ ì „ì²´ ë¡œê·¸ì¸ ì´ˆê¸°í™” ì™„ë£Œ");
    }
    
    msg.innerHTML = '<span class="success">ëª¨ë“  ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</span>';
    
    // 3ì´ˆ í›„ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
    setTimeout(() => {
      document.getElementById("adminScreen").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
    }, 3000);

  } catch (error) {
    showDebug(`ë¡œê·¸ì¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ${error.message}`, true);
    msg.textContent = `ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
  }
}

// PWA ì„¤ì¹˜ ì´ë²¤íŠ¸
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installPrompt').style.display = 'block';
});

// JSON ë¡œë”
async function loadJsonFlexible(url){
  const res = await fetch(url + "?t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + res.status);
 
  const text = await res.text();
  const cleaned = text.replace(/^\uFEFF/, "");
  let json = JSON.parse(cleaned);

  if(json && typeof json === "object" && !Array.isArray(json) && Array.isArray(json.data)){
    json = json.data;
  }
  if(!Array.isArray(json)) throw new Error("JSONì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
 
  return json;
}

// ë°ì´í„° ë¡œë“œ
async function loadAllData(){
  try{
    const [emp, dis] = await Promise.all([
      loadJsonFlexible(EMP_URL),
      loadJsonFlexible(DIS_URL)
    ]);

    employees = emp.map(e => ({
      empno: String(e.empno || e.code || "").trim(),
      password: String(e.password || "").trim()
    })).filter(e => e.empno && e.password);

    diseases = dis.map(d => ({
      name: String(d.name || "").trim(),
      acceptance: String(d.acceptance || ""),
      signature355: String(d.signature355 || ""),
      treatmentDays: String(d.treatmentDays || ""),
      surgery: String(d.surgery || ""),
      recurrence: String(d.recurrence || ""),
      restrictions: String(d.restrictions || "")
    })).filter(d => d.name);

    document.getElementById("empMeta").textContent =
      `ìŠ¹ì¸ì‚¬ë²ˆ ${employees.length}ê±´ â€¢ ì§ˆë³‘ë°ì´í„° ${diseases.length}ê±´ â€¢ ê´€ë¦¬ì: 8091768`;

    showDebug(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ì§ì› ${employees.length}ëª…, ì§ˆë³‘ ${diseases.length}ê°œ`);

  }catch(err){
    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
    showDebug(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, true);
    document.getElementById("loginMsg").textContent = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
  }
}

// ë¡œê·¸ì¸
function login(){
  const empno = document.getElementById("empno").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  if(!empno || !password) {
    msg.textContent = "ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    return;
  }

  if(!employees.length){
    msg.textContent = "ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    return;
  }

  const user = employees.find(u => u.empno === empno && u.password === password);
 
  if(user){
    currentUser = empno;
    
    // ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥ (ìë™ ë¡œê·¸ì¸ìš©)
    localStorage.setItem('hwg_current_user', empno);
    
    // ë¡œê·¸ì¸ ë¡œê·¸ ê¸°ë¡
    saveLog(empno, 'login', `Login successful from ${window.location.href}`);
   
    showLoginSuccess();
    msg.textContent = "";
    showDebug(`ë¡œê·¸ì¸ ì„±ê³µ: ${empno}`);
  }else{
    msg.textContent = "ì½”ë“œ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    showDebug(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${empno}`);
  }
}

// ë³´í—˜íšŒì‚¬ ì—°ë½ì²˜ í‘œì‹œ
function showInsuranceContacts() {
  const insuranceSection = document.getElementById("insuranceContacts");
  const insuranceList = document.getElementById("insuranceList");
  
  console.log("showInsuranceContacts í˜¸ì¶œë¨");
  console.log("insuranceCompanies ê¸¸ì´:", insuranceCompanies.length);
  console.log("insuranceSection:", insuranceSection);
  console.log("insuranceList:", insuranceList);
  
  if (!insuranceCompanies.length) {
    console.log("ë³´í—˜íšŒì‚¬ ë°ì´í„°ê°€ ì—†ìŒ");
    insuranceSection.style.display = "none";
    return;
  }
  
  insuranceSection.style.display = "block";
  console.log("ë³´í—˜íšŒì‚¬ ì„¹ì…˜ í‘œì‹œí•¨");
  
  const cards = insuranceCompanies.map(company => {
    const faxDisplay = company.fax === "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜" ? 
      `<span style="color: #888; font-style: italic;">${company.fax}</span>` : 
      company.fax;
    
    return `
      <div class="insurance-card">
        <img src="${company.logoUrl}" alt="${company.company}" class="insurance-logo" 
             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <div style="display:none; width:120px; height:40px; background:#f0f0f0; border-radius:8px; flex-shrink:0; align-items:center; justify-content:center; font-size:12px; color:#666;">${company.company}</div>
        <div class="insurance-info">
          <div class="insurance-company">${company.company}</div>
          <div class="insurance-contact">
            <div class="contact-item">
              <span class="contact-icon">ğŸ“</span>
              <a href="tel:${company.callCenter.replace(/-/g, '')}">${company.callCenter}</a>
            </div>
            <div class="contact-item">
              <span class="contact-icon">ğŸ“ </span>
              <span>${faxDisplay}</span>
            </div>
            <div class="contact-item">
              <span class="contact-icon">ğŸ”—</span>
              <a href="${company.termsUrl}" target="_blank" rel="noopener">ì•½ê´€í•¨</a>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  insuranceList.innerHTML = cards;
  console.log("ë³´í—˜íšŒì‚¬ ì¹´ë“œ HTML ìƒì„±ë¨:", cards.length);
  showDebug(`ë³´í—˜íšŒì‚¬ ì—°ë½ì²˜ ${insuranceCompanies.length}ê°œ í‘œì‹œë¨`);
}

// ê²€ìƒ‰ ì •ê·œí™”
function normalize(str){
  return String(str || "").toLowerCase().replace(/[\sÃ‚Â·,\-\.]/g, "");
}

// ê²€ìƒ‰
function search(){
  const query = document.getElementById("searchInput").value.trim();
  const results = document.getElementById("results");
 
  if(!query){
    results.innerHTML = '<div class="hint">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
    return;
  }

  if(!diseases.length) {
    results.innerHTML = '<div class="error">ì§ˆë³‘ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // ê²€ìƒ‰ ë¡œê·¸ ì €ì¥
  if(currentUser) {
    saveLog(currentUser, 'search', query);
    showDebug(`ê²€ìƒ‰ ì‹¤í–‰: ${currentUser} - "${query}"`);
  }

  const tokens = query.split(/[\sÃ‚Â·,\-\.]+/).filter(Boolean).map(normalize);
 
  const matched = diseases.filter(d => {
    const name = normalize(d.name);
   
    // ê¸°ë³¸ ê²€ìƒ‰ (ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬ëœ í† í°ë“¤ì´ ëª¨ë‘ í¬í•¨)
    if(tokens.every(token => name.includes(token))) {
      return true;
    }
   
    // ë‹¨ì¼ í† í° ë¶„í•  ê²€ìƒ‰ (3ê¸€ì ì´ìƒ, 2ê¸€ìì”© ì¡°í•©, ìˆœì„œ ê³ ë ¤)
    if(tokens.length === 1) {
      const token = tokens[0];
      if(token.length >= 3) {
        for(let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
         
          if(left.length >= 2 && right.length >= 2) {
            const leftPos = name.indexOf(left);
            const rightPos = name.indexOf(right);
           
            if(leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              return true;
            }
          }
        }
      }
    }
   
    return false;
  });

  if(!matched.length){
    results.innerHTML = '<div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  results.innerHTML = matched.map(d => `
    <div class="result-card">
      <div class="result-title">${d.name}</div>
      <div class="result-sub">ì¸ìˆ˜ê¸°ì¤€: ${d.acceptance || "-"}</div>
      <div class="result-sub">ì‹œê·¸ë‹ˆì²˜355: ${d.signature355 || "-"}</div>
      <table class="info-table">
        <tr><th>ì¹˜ë£Œì¼ìˆ˜</th><th>ìˆ˜ìˆ ì—¬ë¶€</th><th>ì¬ë°œì—¬ë¶€</th></tr>
        <tr>
          <td>${d.treatmentDays || "-"}</td>
          <td>${d.surgery || "-"}</td>
          <td>${d.recurrence || "-"}</td>
        </tr>
      </table>
      <div class="restrictions">ì œí•œì‚¬í•­: ${d.restrictions || "ì—†ìŒ"}</div>
    </div>
  `).join('');

  showDebug(`ê²€ìƒ‰ ê²°ê³¼: ${matched.length}ê°œ ë°œê²¬`);
}

// ê´€ë¦¬ì ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° (GitHub ì—°ë™)
async function loadLogs() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  const loadBtn = document.getElementById("loadLogsBtn");
 
  if(password !== "admin123") {
    msg.textContent = "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }
 
  msg.textContent = "";
  loadBtn.innerHTML = '<span class="loading">âŸ³</span> ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  loadBtn.disabled = true;

  try {
    showDebug("ê´€ë¦¬ì ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...");
    
    // GitHubì—ì„œ ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
    userLogs = await loadLogsFromGitHub();
    userLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
   
    const stats = document.getElementById("logStats");
    const results = document.getElementById("logResults");
   
    // í†µê³„
    const totalLogs = userLogs.length;
    const uniqueUsers = new Set(userLogs.map(l => l.empno)).size;
    const loginCount = userLogs.filter(l => l.action === 'login').length;
    const searchCount = userLogs.filter(l => l.action === 'search').length;
    const logoutCount = userLogs.filter(l => l.action === 'logout').length;
   
    stats.textContent = `ì „ì²´ ${totalLogs}ê°œ | ì‚¬ìš©ì ${uniqueUsers}ëª… | ë¡œê·¸ì¸ ${loginCount}íšŒ | ê²€ìƒ‰ ${searchCount}íšŒ | ë¡œê·¸ì•„ì›ƒ ${logoutCount}íšŒ`;
    showDebug(`ë¡œê·¸ í†µê³„: ì´ ${totalLogs}ê°œ, ì‚¬ìš©ì ${uniqueUsers}ëª…`);
   
    // ë¡œê·¸ ëª©ë¡
    if(userLogs.length === 0) {
      results.innerHTML = '<div class="hint">ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    } else {
      const actionNames = {
        'login': 'ë¡œê·¸ì¸',
        'logout': 'ë¡œê·¸ì•„ì›ƒ', 
        'search': 'ê²€ìƒ‰',
        'reset_all_logins': 'ì „ì²´ ë¡œê·¸ì¸ ì´ˆê¸°í™”',
        'test_connection': 'GitHub ì—°ê²° í…ŒìŠ¤íŠ¸'
      };

      results.innerHTML = userLogs.slice(0, 50).map(log => `
        <div class="log-card">
          <div class="log-header">ì½”ë“œ: ${log.empno} - ${actionNames[log.action] || log.action}</div>
          <div class="log-time">${log.date}</div>
          ${log.details ? `<div class="log-search">ìƒì„¸: "${log.details}"</div>` : ''}
        </div>
      `).join('');
      
      if(userLogs.length > 50) {
        results.innerHTML += `<div class="hint">ìµœê·¼ 50ê°œ ë¡œê·¸ë§Œ í‘œì‹œë©ë‹ˆë‹¤. (ì „ì²´ ${userLogs.length}ê°œ)</div>`;
      }
    }
    
    showDebug("ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
    msg.innerHTML = '<span class="success">ë¡œê·¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</span>';
  } catch (error) {
    showDebug(`ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`, true);
    msg.textContent = "ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message;
  } finally {
    loadBtn.innerHTML = 'ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°';
    loadBtn.disabled = false;
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM ë¡œë“œ ì™„ë£Œ");
  
  try {
    // ë³´í—˜íšŒì‚¬ ë°ì´í„° ë¨¼ì € ì´ˆê¸°í™”
    initializeInsuranceData();
    console.log("ë³´í—˜íšŒì‚¬ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ");
    
    // ë°ì´í„° ë¡œë“œ ë° ìë™ ë¡œê·¸ì¸ ì²´í¬
    Promise.all([loadAllData()]).then(() => {
      checkAutoLogin();
    }).catch(err => {
      console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
    });
  } catch(err) {
    console.error("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", err);
  }
 
  // ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  try {
    const loginBtn = document.getElementById('loginBtn');
    const empnoInput = document.getElementById('empno');
    const passwordInput = document.getElementById('password');
    
    console.log("ë¡œê·¸ì¸ ë²„íŠ¼ ìš”ì†Œ:", loginBtn);
    console.log("ì…ë ¥ í•„ë“œë“¤:", empnoInput, passwordInput);
    
    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        console.log("ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨");
        login();
      });
    }
    
    if (empnoInput) {
      empnoInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') {
          passwordInput && passwordInput.focus();
        }
      });
    }
    
    if (passwordInput) {
      passwordInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') login();
      });
    }
  } catch(err) {
    console.error("ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", err);
  }

  // ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  try {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
    }
  } catch(err) {
    console.error("ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", err);
  }
 
  // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  try {
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    
    if (searchBtn) {
      searchBtn.addEventListener('click', search);
    }
    
    if (searchInput) {
      searchInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') search();
      });
    }
  } catch(err) {
    console.error("ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", err);
  }
 
  // ê´€ë¦¬ì ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  try {
    const adminBtn = document.getElementById('adminBtn');
    if (adminBtn) {
      adminBtn.addEventListener('click', () => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('searchScreen').style.display = 'none';
        document.getElementById('adminScreen').style.display = 'flex';
      });
    }
    
    const loadLogsBtn = document.getElementById('loadLogsBtn');
    const adminPassword = document.getElementById('adminPassword');
    
    if (loadLogsBtn) {
      loadLogsBtn.addEventListener('click', loadLogs);
    }
    
    if (adminPassword) {
      adminPassword.addEventListener('keydown', e => {
        if(e.key === 'Enter') loadLogs();
      });
    }

    // GitHub í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    const testGitHubBtn = document.getElementById('testGitHubBtn');
    if (testGitHubBtn) {
      testGitHubBtn.addEventListener('click', testGitHubConnection);
    }

    // ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™” ë²„íŠ¼
    const resetLoginBtn = document.getElementById('resetLoginBtn');
    if (resetLoginBtn) {
      resetLoginBtn.addEventListener('click', resetAllLogins);
    }
    
    const backToSearchBtn = document.getElementById('backToSearchBtn');
    if (backToSearchBtn) {
      backToSearchBtn.addEventListener('click', () => {
        document.getElementById('adminScreen').style.display = 'none';
        if(currentUser) {
          document.getElementById('searchScreen').style.display = 'flex';
        } else {
          document.getElementById('loginScreen').style.display = 'flex';
        }
      });
    }
  } catch(err) {
    console.error("ê´€ë¦¬ì ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", err);
  }
 
  // PWA ì„¤ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  try {
    const installBtn = document.getElementById('installBtn');
    const installPrompt = document.getElementById('installPrompt');
    
    console.log("ì„¤ì¹˜ ë²„íŠ¼ ìš”ì†Œ:", installBtn);
    
    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        console.log("ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ë¨");
        if(deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installPrompt && (installPrompt.style.display = 'none');
        } else {
          alert('ë¸Œë¼ìš°ì €ì—ì„œ í™ˆí™”ë©´ ì¶”ê°€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        }
      });
    }
    
    if (installPrompt) {
      installPrompt.addEventListener('click', () => {
        installBtn && installBtn.click();
      });
    }
  } catch(err) {
    console.error("PWA ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", err);
  }
  
  console.log("ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ");
});
</script>

</body>
</html>
