<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒê° ì•ˆ ë‚  ë•? ë¨¸ë“œë¼!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 70px;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .header-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg);
      border-bottom: 2px solid #ccc;
      padding: 8px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-left {
      flex: 1;
    }
    
    .header-center {
      flex: 1;
      text-align: center;
    }
    
    .header-right {
      flex: 1;
      text-align: right;
    }
    
    .logo-container {
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .logo-container:hover {
      transform: scale(1.05);
    }
    
    .logo-main {
      font-size: 32px;
      font-weight: 900;
      color: var(--hanwha);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(255,127,0,0.2);
      margin: 0;
      line-height: 1;
    }
    
    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
      margin-top: 2px;
      letter-spacing: 1px;
      opacity: 0.8;
    }
    
    .logo-container:hover .logo-main {
      color: var(--hanwha-dark);
      text-shadow: 0 4px 8px rgba(255,127,0,0.3);
    }
    
    .logo-container:hover .logo-sub {
      opacity: 1;
    }
    
    .user-info-header {
      background: rgba(255,127,0,0.1);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--hanwha);
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .user-info-header button {
      padding: 3px 8px;
      font-size: 11px;
      margin: 0;
      width: auto;
      min-width: 50px;
      background: #28a745;
      border-radius: 12px;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    
    .user-info-header button:hover {
      background: #218838;
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input, select{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.logout{
      background:#28a745;
      margin-bottom:8px;
    }
    button.logout:hover{background:#218838}
    button.small{
      width:auto;
      padding:4px 6px;
      font-size:11px;
      margin:0 2px 0 0;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .container-narrow{max-width:760px}
    .container-wide{max-width:1200px}
    .results{margin-top:1rem}
    .result-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:12px;
    }
    .result-title{
      font-size:18px;
      font-weight:700;
      color:#222;
      margin-bottom:6px;
    }
    .result-sub{color:#444; margin:.25rem 0 .5rem 0}
    .info-table{
      width:100%;
      border-collapse:collapse;
      margin-top:.25rem;
      font-size:14px;
    }
    .info-table th,.info-table td{
      border:1px solid var(--border);
      padding:8px;
      text-align:center;
      white-space:nowrap;
    }
    .restrictions{
      margin-top:.5rem;
      padding:.5rem .75rem;
      background:#fafafa;
      border:1px dashed var(--border);
      border-radius:10px;
      font-size:14px;
      white-space:pre-line;
    }
    .meta{
      margin-top:.5rem;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
    .guide-table{
      width:100%;
      border-collapse:collapse;
      margin-top:.5rem;
      font-size:14px;
    }
    .guide-table th,.guide-table td{
      border:1px solid var(--border);
      padding:10px 8px;
      text-align:left;
      vertical-align:top;
    }
    .guide-table th{
      background:#f8f9fa;
      font-weight:700;
      text-align:center;
      width:20%;
    }
    .guide-table .type-col{
      font-weight:600;
      color:var(--hanwha);
      text-align:center;
      width:20%;
    }
    .guide-table .content-col{
      width:80%;
      white-space:pre-line;
      line-height:1.4;
    }
    
    .insurance-section{
      margin-top:1.5rem;
    }
    .insurance-card.hanwha{
      background:#fff;
      border:3px solid var(--hanwha);
      border-radius:14px;
      padding:20px;
      box-shadow:0 4px 12px rgba(255,127,0,0.15);
      margin-bottom:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:15px;
    }
    
    /* ê°œì„ ëœ ì—°ë½ì²˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ - 1ì—´ ê·¸ë¦¬ë“œ */
    .insurance-grid{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .insurance-card.small{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
    }
    
    .insurance-logo{
      width:120px;
      height:40px;
      object-fit:contain;
      flex-shrink:0;
      background:#f0f0f0;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      color:#333;
      font-weight:600;
      margin-bottom:15px;
    }
    .insurance-logo.small{
      width:200px;
      height:35px;
      margin-bottom:15px;
      font-size:16px;
    }
    
    .insurance-info{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    
    /* ê°œì„ ëœ ì—°ë½ì²˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .contact-button-group {
      display:flex;
      flex-direction:column;
      gap:8px;
      width:100%;
      max-width:280px;
    }
    
    .contact-button {
      padding:12px 20px;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s ease;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    
    .contact-button.call {
      background:#28a745;
      color:white;
    }
    
    .contact-button.call:hover {
      background:#218838;
      transform:translateY(-2px);
    }
    
    .contact-button.fax {
      background:#007bff;
      color:white;
    }
    
    .contact-button.fax:hover {
      background:#0056b3;
      transform:translateY(-2px);
    }
    
    .contact-button.terms {
      background:#6c757d;
      color:white;
    }
    
    .contact-button.terms:hover {
      background:#545b62;
      transform:translateY(-2px);
    }
    
    /* í•œí™”ì†ë³´ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    .insurance-card.hanwha .contact-button-group {
      max-width:320px;
    }
    
    .insurance-card.hanwha .contact-button {
      padding:14px 24px;
      font-size:17px;
    }
    
    .insurance-category h3{
      font-size:18px;
      font-weight:700;
      color:#333;
      margin:1.5rem 0 1rem 0;
      text-align:center;
      border-bottom:2px solid var(--hanwha);
      padding-bottom:8px;
    }

    /* ì¸ìˆ˜í•œë„ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ ê°œì„  */
    .limit-table-container {
      position: relative;
      overflow: auto;
      max-height: 70vh;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    .limit-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      background: white;
      table-layout: fixed;
    }
    
    .limit-table th, .limit-table td{
      border: 1px solid var(--border);
      padding: 8px 4px;
      text-align: center;
      vertical-align: middle;
      background: white;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .limit-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      font-weight: 600;
      z-index: 10;
      border-bottom: 2px solid var(--hanwha);
    }
    
    .limit-table .detail-btn{
      width: 15%;
      min-width: 45px;
      font-size: 11px;
    }
    
    .limit-table .coverage-name{
      width: 60%;
      text-align: left;
      font-weight: 600;
      word-break: break-word;
      padding-left: 8px;
    }
    
    .limit-table .amount{
      width: 25%;
      font-weight: 600;
      color: var(--hanwha);
    }
    
    .coverage-clickable {
      cursor: pointer;
      color: var(--hanwha);
      text-decoration: underline;
    }
    
    .coverage-clickable:hover {
      color: var(--hanwha-dark);
    }
    
    .coverage-search-container {
      margin-top: 10px;
    }
    
    .coverage-search-container input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    
    .coverage-search-container input:focus {
      border-color: var(--hanwha);
    }

    .product-plan-info {
      position: sticky;
      top: 0;
      background: white;
      padding: 15px 20px;
      border-bottom: 2px solid var(--hanwha);
      margin: -20px -20px 20px -20px;
      z-index: 20;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* íŒì—… ëª¨ë‹¬ */
    .modal{
      display:none;
      position:fixed;
      z-index:2000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
    }
    .modal-content{
      background:#fff;
      margin:10% auto;
      padding:20px;
      border-radius:16px;
      width:90%;
      max-width:600px;
      max-height:70vh;
      overflow-y:auto;
      position:relative;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1rem;
      padding-bottom:1rem;
      border-bottom:1px solid var(--border);
    }
    .modal-title{
      font-size:18px;
      font-weight:700;
      color:var(--text);
    }
    .close{
      color:#aaa;
      font-size:28px;
      font-weight:bold;
      cursor:pointer;
      line-height:1;
    }
    .close:hover{
      color:#000;
    }
    .modal-body{
      white-space:pre-line;
      line-height:1.6;
      color:var(--text);
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      .limit-table{
        font-size:12px;
      }
      .limit-table th, .limit-table td{
        padding:6px 2px;
      }
      .limit-table .detail-btn{
        width: 18%;
        min-width: 40px;
        font-size: 10px;
      }
      .limit-table .coverage-name{
        width: 57%;
        font-size:11px;
        padding-left: 4px;
      }
      .limit-table .amount{
        width: 25%;
        font-size:11px;
      }
      .container-wide{
        max-width:100%;
        padding:0 10px;
      }
      .card{
        max-width:100%;
        margin:0 10px;
      }
      .product-plan-info {
        margin: -20px -10px 20px -10px;
        padding: 10px 15px;
      }
      .guide-table th, .guide-table td{
        padding:8px 4px;
        font-size:12px;
      }
      
      /* ëª¨ë°”ì¼ ì—°ë½ì²˜ ë²„íŠ¼ ìµœì í™” */
      .insurance-logo.small{
        width:100%;
        max-width:250px;
        font-size:15px;
      }
      
      .contact-button-group {
        max-width:100%;
      }
      
      .contact-button {
        font-size:15px;
        padding:11px 18px;
      }
      
      .insurance-card.hanwha .contact-button {
        font-size:16px;
        padding:13px 22px;
      }
    }
  </style>
</head>
<body>
  <div class="header-fixed">
    <div class="header-left"></div>
    <div class="header-center">
      <div class="logo-container" onclick="goHome()">
        <div class="logo-main">ë¨¸ë“œë¼</div>
      </div>
    </div>
    <div class="header-right">
      <div id="userInfoHeader" class="user-info-header">
        <span id="userTextHeader"></span>
        <button id="logoutBtnHeader">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <section id="loginScreen" class="screen">
    <div class="app-title">ë­ë”ë¼.. ì–´ë”¨ë”ë¼..</div>
    <div class="card">
      <h2>ë¡œê·¸ì¸</h2>
      <div class="row">
        <input id="empno" type="text" placeholder="ì½”ë“œ ì…ë ¥" autocomplete="username">
      </div>
      <div class="row">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
        <div class="hint">ì‚¬ì „ ìŠ¹ì¸ëœ ê¸°ê´€ë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. </div>
      </div>
      <button id="loginBtn">ë¡œê·¸ì¸</button>
      <button id="installBtn" class="secondary">í™ˆí™”ë©´ì— ì¶”ê°€</button>
      <div id="loginMsg" class="error"></div>
      <div class="meta" id="empMeta"></div>
      <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- ë©”ë‰´ í™”ë©´ -->
  <section id="menuScreen" class="screen" style="display:none;">
    <div class="app-title">ë­ë”ë¼.. ì–´ë”¨ë”ë¼..</div>
    <div class="card">
      <h2 style="margin-bottom:1.5rem;">ë©”ë‰´ ì„ íƒ</h2>
      
      <button id="guideMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ</span>
        <span style="font-size:14px; opacity:0.8;">(ê±´ê°•ê³ ì§€/ì¼ë°˜ê³ ì§€/ê°„í¸ê³ ì§€)</span>
      </button>
      
      <button id="diseaseMenuBtn" style="margin-bottom:1rem; display:none;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">í•œí™”ì†ë³´ SI ì¦‰ì‹œ ì¸ìˆ˜ ì§ˆí™˜</span>
      </button>
      
      <button id="contactMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ì½œì„¼í„°, ë³´í—˜ê¸ˆ ì²­êµ¬ íŒ©ìŠ¤</span>
      </button>

      <button id="limitMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ìƒí’ˆë³„/í”Œëœë³„ ì¸ìˆ˜í•œë„</span>
      </button>
      
      <div class="meta" style="margin-top:2rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ê²€ìƒ‰ í™”ë©´ -->
  <section id="guideScreen" class="screen" style="display:none;">
    <div class="app-title">í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ</div>
        <div class="app-title">(ê±´ê°•ê³ ì§€/ì¼ë°˜ê³ ì§€/ê°„í¸ê³ ì§€)</div>
    <div class="card container-narrow">
      <h2 style="margin-bottom:.5rem;">ì§ˆë³‘ëª… ê²€ìƒ‰</h2>
      <div class="row">
        <input id="guideSearchInput" type="text" placeholder="ì˜ˆì‹œ: ìš©ì¢…, ê³¨ì ˆ, ë‹¹ë‡¨ ë“±">
      </div>
      <div id="guideSearchMessage" class="hint" style="margin-bottom:1rem; display:none;"></div>
      
      <button id="guideSearchBtn">ê²€ìƒ‰</button>
      <button id="guideBackBtn" class="secondary" style="display:none; margin-top:8px;">ë’¤ë¡œê°€ê¸°</button>
      
      <div class="results" id="guideResults"></div>
      <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- ê²€ìƒ‰ í™”ë©´ -->
  <section id="searchScreen" class="screen" style="display:none;">
    <div class="app-title">í•œí™”ì†ë³´ SI ì¦‰ì‹œ ì¸ìˆ˜ ì§ˆí™˜</div>
    <div class="card container-narrow">
      <h2 style="margin-bottom:.5rem;">ì§ˆë³‘ëª… ê²€ìƒ‰</h2>
      <div class="row">
        <input id="searchInput" type="text" placeholder="ì˜ˆì‹œ: ìš©ì¢…, ê³¨ì ˆ, ë‹¹ë‡¨ ë“±">
      </div>
      <div id="searchMessage" class="hint" style="margin-bottom:1rem; display:none;"></div>
      
      <button id="searchBtn">ê²€ìƒ‰</button>
      <button id="backBtn" class="secondary" style="display:none; margin-top:8px;">ë’¤ë¡œê°€ê¸°</button>
      
      <div class="results" id="results"></div>
      <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- ì—°ë½ì²˜ í™”ë©´ -->
  <section id="contactScreen" class="screen" style="display:none;">
    <div class="app-title">ì½œì„¼í„°, ë³´í—˜ê¸ˆ ì²­êµ¬ íŒ©ìŠ¤</div>
    <div class="card container-narrow">
      <div class="insurance-section">
        <div id="insuranceListContact"></div>
      </div>
      
      <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- ì¸ìˆ˜í•œë„ í™”ë©´ -->
  <section id="limitScreen" class="screen" style="display:none;">
    <div class="app-title">ìƒí’ˆë³„/í”Œëœë³„ ì¸ìˆ˜í•œë„</div>
    <div class="card container-narrow">
      <h2 style="margin-bottom:1rem;">ìƒí’ˆ ë° í”Œëœ ì„ íƒ</h2>
      
      <div class="row">
        <select id="productSelect">
          <option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <div class="row">
        <select id="planSelect" disabled>
          <option value="">í”Œëœì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <div class="row" id="ageSelectRow" style="display:none;">
        <select id="ageSelect" disabled>
          <option value="">ì—°ë ¹êµ¬ê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <button id="limitBackBtn" class="secondary" style="margin-top:8px;">ë’¤ë¡œê°€ê¸°</button>
      
      <div id="limitResults" class="results"></div>
      <div class="meta" style="margin-top:1rem;">Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.</div>
    </div>
  </section>

  <!-- ìƒì„¸ì¡°íšŒ ëª¨ë‹¬ -->
  <div id="noteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ë¹„ê³  ìƒì„¸ì¡°íšŒ</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body" id="noteModalBody"></div>
    </div>
  </div>

<script>
let employees = [];
let diseases = [];
let guideData = [];
let limitData = [];
let currentUser = null;
let isAdminUser = false;
let currentScreen = 'login';
const screenHistory = [];

const EMP_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/employees.json";
const DIS_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/diseases.json";
const GUIDE_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/udw_dcw.json";

const ADMIN_ACCOUNT = {
  empno: "8091768",
  password: "dcw8091"
};

const INSURANCE_COMPANIES = [
  {"company": "í•œí™”ì†í•´ë³´í—˜", "callCenter": "1566-8000", "fax": "0502-779-1004", "termsUrl": "https://www.hwgeneralins.com/notice/ir/product-ing01.do"},
  {"company": "ì‚¼ì„±í™”ì¬", "callCenter": "1588-5114", "fax": "0505-162-0872", "termsUrl": "https://www.samsungfire.com/vh/page/VH.HPIF0103.do"},
  {"company": "ë©”ë¦¬ì¸ í™”ì¬", "callCenter": "1566-7711", "fax": "0505-021-3400", "termsUrl": "https://www.meritzfire.com/disclosure/product-announcement/product-list.do#!/"},
  {"company": "DBì†í•´ë³´í—˜", "callCenter": "1588-0100", "fax": "0505-181-4862", "termsUrl": "https://www.idbins.com/FWMAIV1534.do"},
  {"company": "KBì†í•´ë³´í—˜", "callCenter": "1544-0114", "fax": "0505-136-6500", "termsUrl": "https://www.kbinsure.co.kr/CG802030001.ec"},
  {"company": "í˜„ëŒ€í•´ìƒ", "callCenter": "1588-5656", "fax": "0507-774-6060", "termsUrl": "https://www.hi.co.kr/serviceAction.do?view=bin/PA/03/HHPA03010M#none"},
  {"company": "ë¡¯ë°ì†í•´ë³´í—˜", "callCenter": "1588-3344", "fax": "0507-333-9999", "termsUrl": "https://www.lotteins.co.kr/web/C/D/H/cdh190.jsp"},
  {"company": "í¥êµ­í™”ì¬", "callCenter": "1688-1688", "fax": "0504-800-0700", "termsUrl": "https://www.heungkukfire.co.kr/FRW/announce/insGoodsGongsiSale.do"},
  {"company": "í•˜ë‚˜ì†í•´ë³´í—˜", "callCenter": "1566-3000", "fax": "0505-170-0765", "termsUrl": "https://www.hanainsure.co.kr/w/disclosure/product/saleProduct"},
  {"company": "NHë†í˜‘ì†í•´ë³´í—˜", "callCenter": "1644-9000", "fax": "0505-060-7000", "termsUrl": "https://www.nhfire.co.kr/announce/productAnnounce/retrieveInsuranceProductsAnnounce.nhfire"},
  {"company": "ë¼ì´ë‚˜ì†í•´ë³´í—˜", "callCenter": "1566-5800", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://www.lina.co.kr/disclosure/product-public-announcement/product-on-sales?key=0%3FproductState%3D01&productKind=01"},
  {"company": "AIGì†í•´ë³´í—˜", "callCenter": "1544-2792", "fax": "02-2011-4607", "termsUrl": "https://www.aig.co.kr/wo/dpwot001.html?menuId=MS702"},
  {"company": "í•œí™”ìƒëª…", "callCenter": "1588-6363", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://www.hanwhalife.com/main/disclosure/goods/disclosurenotice/DF_GDDN000_P10000.do?MENU_ID1=DF_GDGL000"},
  {"company": "ë™ì–‘ìƒëª…", "callCenter": "1577-1004", "fax": "02-3289-4516", "termsUrl": "https://pbano.myangel.co.kr/paging/WE_AC_WEPAAP020100L"},
  {"company": "êµë³´ìƒëª…", "callCenter": "1588-1001", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://www.kyobo.com/dgt/web/product-official/all-product/search"},
  {"company": "ì‚¼ì„±ìƒëª…", "callCenter": "1588-3114", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://www.samsunglife.com/individual/products/disclosure/sales/PDO-PRPRI010110M"},
  {"company": "ë¼ì´ë‚˜ìƒëª…", "callCenter": "1588-0058", "fax": "02-6944-1200", "termsUrl": "https://www.lina.co.kr/disclosure/product-public-announcement/product-on-sales?key=0%3FproductState%3D01&productKind=01"},
  {"company": "KDBìƒëª…", "callCenter": "1588-4040", "fax": "02-2669-6500", "termsUrl": "https://www.kdblife.co.kr/ajax.do?scrId=HDLMA002M02P"},
  {"company": "MGìƒˆë§ˆì„ê¸ˆê³ ", "callCenter": "1599-9010", "fax": "02-3016-7674", "termsUrl": "https://insure.kfcc.co.kr/#/PGE_IHJ_00003"},
  {"company": "ë”ì¼€ì´", "callCenter": "1577-3993", "fax": "02-3278-9696", "termsUrl": "https://www.ktcu.or.kr/PPW-FIC-800101"},
  {"company": "ìš°ì²´êµ­", "callCenter": "1599-0100", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://mall.epostbank.go.kr/IPPSKE0000.do"},
  {"company": "ìˆ˜í˜‘ê³µì œ", "callCenter": "1588-4119", "fax": "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜", "termsUrl": "https://www.suhyup-bank.com/"}
];

// ì¸ìˆ˜í•œë„ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
const LIMIT_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/limits.json";

async function loadLimitData() {
  try {
    limitData = await loadJsonFlexible(LIMIT_URL);
    console.log("ì¸ìˆ˜í•œë„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", limitData.length + "ê±´");
    
    // í˜„ì¬ ì¸ìˆ˜í•œë„ í™”ë©´ì´ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
    if (currentScreen === 'limit') {
      updateProductSelect();
    }
  } catch(err) {
    console.error("ì¸ìˆ˜í•œë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

// í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadGuideData() {
  try {
    guideData = await loadJsonFlexible(GUIDE_URL);
    console.log("í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", guideData.length + "ê±´");
  } catch(err) {
    console.error("í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

// ì—°ë½ì²˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleContactButton(type, value, company) {
  if (type === 'call') {
    // ì „í™”ê±¸ê¸°
    window.location.href = `tel:${value.replace(/-/g, '')}`;
  } else if (type === 'fax') {
    // íŒ©ìŠ¤ ë²ˆí˜¸ ì²˜ë¦¬ (í´ë¦½ë³´ë“œ ë³µì‚¬ ë° ì˜µì…˜ ì œê³µ)
    handleFaxButton(value, company);
  } else if (type === 'terms') {
    // ê³µì‹œì‹¤ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
    window.open(value, '_blank');
  }
}

// íŒ©ìŠ¤ ë²„íŠ¼ ì²˜ë¦¬ í•¨ìˆ˜
function handleFaxButton(faxNumber, company) {
  if (faxNumber === "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜") {
    alert(`${company}ì€ íŒ©ìŠ¤ ì ‘ìˆ˜ê°€ ë¶ˆê°€í•˜ë©°, ì½œì„¼í„°ë¡œ ì „í™” ì ‘ìˆ˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
    return;
  }
  
  // í´ë¦½ë³´ë“œ API ì§€ì› í™•ì¸
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(faxNumber).then(() => {
      // ì„±ê³µì ìœ¼ë¡œ ë³µì‚¬ëœ ê²½ìš°
      const options = [
        '1. í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨',
        '2. ë‹¤ë¥¸ ì•±ìœ¼ë¡œ ê³µìœ í•˜ê¸°',
        '3. ì·¨ì†Œ'
      ];
      
      // ê°„ë‹¨í•œ í™•ì¸ ëŒ€í™”ìƒìë¡œ ì˜µì…˜ ì œê³µ
      const choice = confirm(`íŒ©ìŠ¤ë²ˆí˜¸: ${faxNumber}\n\ní´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì•±ìœ¼ë¡œ ê³µìœ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
      
      if (choice) {
        // Web Share API ì§€ì› í™•ì¸
        if (navigator.share) {
          navigator.share({
            title: `${company} íŒ©ìŠ¤ë²ˆí˜¸`,
            text: `${company} íŒ©ìŠ¤ë²ˆí˜¸: ${faxNumber}`
          }).catch(err => {
            console.log('ê³µìœ  ì·¨ì†Œë¨:', err);
          });
        } else {
          // Web Share APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
          const shareText = `${company} íŒ©ìŠ¤ë²ˆí˜¸: ${faxNumber}`;
          const shareUrl = `mailto:?subject=${encodeURIComponent(company + ' íŒ©ìŠ¤ë²ˆí˜¸')}&body=${encodeURIComponent(shareText)}`;
          window.open(shareUrl);
        }
      }
    }).catch(err => {
      // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•
      console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
      fallbackCopyText(faxNumber);
    });
  } else {
    // í´ë¦½ë³´ë“œ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
    fallbackCopyText(faxNumber);
  }
}

// í´ë¦½ë³´ë“œ ë³µì‚¬ ëŒ€ì²´ í•¨ìˆ˜
function fallbackCopyText(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.opacity = '0';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
    alert(`íŒ©ìŠ¤ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${text}`);
  } catch (err) {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    alert(`íŒ©ìŠ¤ë²ˆí˜¸: ${text}`);
  }
  
  document.body.removeChild(textArea);
}

// ìƒí’ˆê³¼ í”Œëœ ëª©ë¡ ì¶”ì¶œ í•¨ìˆ˜
function extractProductsAndPlans() {
  const products = new Set();
  const plans = new Map();
  
  // limitDataê°€ ì—†ìœ¼ë©´ ë¹ˆ ê²°ê³¼ ë°˜í™˜
  if (!limitData || limitData.length === 0) {
    return { products: [], plans: new Map() };
  }
  
  limitData.forEach(item => {
    if (item.product && item.plan) {
      products.add(item.product);
      
      if (!plans.has(item.product)) {
        plans.set(item.product, new Set());
      }
      plans.get(item.product).add(item.plan);
    }
  });
  
  return { products: Array.from(products), plans };
}

// ì—°ë ¹êµ¬ê°„ ì¶”ì¶œ í•¨ìˆ˜
function extractAgeRanges(selectedProduct, selectedPlan) {
  const filteredData = limitData.filter(item => 
    item.product === selectedProduct && item.plan === selectedPlan
  );
  
  const ageRanges = new Set();
  filteredData.forEach(item => {
    ageRanges.add(`${item.minAge}ì„¸~${item.maxAge}ì„¸`);
  });
  
  return Array.from(ageRanges).sort((a, b) => {
    const ageA = parseInt(a.split('ì„¸')[0]);
    const ageB = parseInt(b.split('ì„¸')[0]);
    return ageA - ageB;
  });
}

// ì¸ìˆ˜í•œë„ í…Œì´ë¸” ìƒì„± í•¨ìˆ˜ (íŠ¹ì • ì—°ë ¹êµ¬ê°„ë§Œ)
function generateLimitTable(selectedProduct, selectedPlan, selectedAgeRange) {
  const filteredData = limitData.filter(item => 
    item.product === selectedProduct && 
    item.plan === selectedPlan &&
    `${item.minAge}ì„¸~${item.maxAge}ì„¸` === selectedAgeRange
  );
  
  if (filteredData.length === 0) {
    return '<div class="hint">í•´ë‹¹ ì¡°ê±´ì˜ ì¸ìˆ˜í•œë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  
  const coverageGroups = new Map();
  filteredData.forEach(item => {
    if (!coverageGroups.has(item.coverage)) {
      coverageGroups.set(item.coverage, []);
    }
    coverageGroups.get(item.coverage).push(item);
  });
  
  let tableHTML = `
    <div class="product-plan-info">
      <div class="result-title">${selectedProduct} - ${selectedPlan} (${selectedAgeRange})</div>
      <div class="coverage-search-container">
        <input id="coverageSearchInput" type="text" placeholder="ë‹´ë³´ëª… ê²€ìƒ‰..." style="margin-top:10px; font-size:14px;">
      </div>
    </div>
    <div class="limit-table-container">
      <table class="limit-table">
        <thead>
          <tr>
            <th class="detail-btn">ìƒì„¸</th>
            <th class="coverage-name">ë‹´ë³´ëª…</th>
            <th class="amount">ì¸ìˆ˜í•œë„</th>
          </tr>
        </thead>
        <tbody id="limitTableBody">
  `;
  
  coverageGroups.forEach((items, coverage) => {
    const item = items[0]; // ì„ íƒëœ ì—°ë ¹êµ¬ê°„ì˜ ë°ì´í„°
    const hasNote = item.note && item.note.trim();
    
    tableHTML += `<tr class="coverage-row" data-coverage="${coverage.toLowerCase()}">`;
    
    if (hasNote) {
      const cleanNote = item.note
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\r?\n/g, '\\n');
      tableHTML += `<td class="detail-btn"><button class="small" onclick="showNoteModal(\`${coverage}\`, \`${cleanNote}\`)">ìƒì„¸</button></td>`;
    } else {
      tableHTML += '<td class="detail-btn">-</td>';
    }
    
    tableHTML += `<td class="coverage-name"><span class="coverage-clickable" onclick="showCoverageDetailModal('${selectedProduct}', '${selectedPlan}', '${coverage}')">${coverage}</span></td>`;
    tableHTML += `<td class="amount">${formatAmount(item.amount)}</td>`;
    tableHTML += '</tr>';
  });
  
  tableHTML += '</tbody></table></div>';
  return tableHTML;
}

function formatAmount(amount) {
  if (!amount || amount === 0) return '-';
  
  // ìˆ«ìë¥¼ ì²œë‹¨ìœ„ ì½¤ë§ˆë¡œ í¬ë§·íŒ…
  const formattedNumber = amount.toLocaleString();
  return formattedNumber + 'ë§Œ';
}

function showNoteModal(coverage, note) {
  // ì´ìŠ¤ì¼€ì´í”„ëœ ë¬¸ìì—´ì„ ì›ë˜ëŒ€ë¡œ ë³µì›
  const restoredNote = note
    .replace(/\\n/g, '\n')
    .replace(/\\"/g, '"')
    .replace(/\\'/g, "'")
    .replace(/\\\\/g, '\\');
    
  document.getElementById('noteModalBody').textContent = restoredNote;
  document.querySelector('.modal-title').textContent = `${coverage} - ë¹„ê³  ìƒì„¸ì¡°íšŒ`;
  document.getElementById('noteModal').style.display = 'block';
}

function showCoverageDetailModal(selectedProduct, selectedPlan, coverage) {
  const filteredData = limitData.filter(item => 
    item.product === selectedProduct && 
    item.plan === selectedPlan &&
    item.coverage === coverage
  );
  
  if (filteredData.length === 0) {
    return;
  }
  
  // ì—°ë ¹ìˆœìœ¼ë¡œ ì •ë ¬
  const sortedData = filteredData.sort((a, b) => a.minAge - b.minAge);
  
  let tableHTML = `
    <table style="width:100%; border-collapse:collapse; margin-top:1rem;">
      <thead>
        <tr style="background:#f8f9fa;">
          <th style="border:1px solid #e6e6e6; padding:8px; text-align:center;">ì—°ë ¹</th>
          <th style="border:1px solid #e6e6e6; padding:8px; text-align:center;">ì¸ìˆ˜í•œë„</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  sortedData.forEach(item => {
    tableHTML += `
      <tr>
        <td style="border:1px solid #e6e6e6; padding:8px; text-align:center;">${item.minAge}ì„¸~${item.maxAge}ì„¸</td>
        <td style="border:1px solid #e6e6e6; padding:8px; text-align:center; font-weight:600; color:#ff7f00;">${formatAmount(item.amount)}</td>
      </tr>
    `;
  });
  
  tableHTML += '</tbody></table>';
  
  document.getElementById('noteModalBody').innerHTML = tableHTML;
  document.querySelector('.modal-title').textContent = coverage;
  document.getElementById('noteModal').style.display = 'block';
}

function closeNoteModal() {
  document.getElementById('noteModal').style.display = 'none';
}

function pushHistory(screen) {
  screenHistory.push(currentScreen);
  currentScreen = screen;
  if (screen !== 'login') {
    history.pushState({ screen: screen }, '', `#${screen}`);
  }
}

window.addEventListener('popstate', function(event) {
  if (event.state && event.state.screen) {
    navigateToScreen(event.state.screen, false);
  } else if (currentUser) {
    navigateToScreen('menu', false);
  } else {
    navigateToScreen('login', false);
  }
});

function navigateToScreen(screen, addToHistory = true) {
  if (addToHistory && screen !== currentScreen) {
    pushHistory(screen);
  } else {
    currentScreen = screen;
  }
  
  hideAllScreens();
  
  switch(screen) {
    case 'login':
      document.getElementById("loginScreen").style.display = "flex";
      document.getElementById("userInfoHeader").style.display = "none";
      break;
    case 'menu':
      document.getElementById("menuScreen").style.display = "flex";
      updateMenuVisibility();
      if (currentUser) {
        document.getElementById("userInfoHeader").style.display = "inline-flex";
        document.getElementById("userTextHeader").textContent = `${currentUser}${isAdminUser ? ' (ê´€ë¦¬ì)' : ''}`;
      }
      break;
    case 'guide':
      document.getElementById("guideScreen").style.display = "flex";
      document.getElementById("guideSearchInput").focus();
      document.getElementById("guideSearchInput").value = "";
      document.getElementById("guideResults").innerHTML = "";
      document.getElementById("guideSearchMessage").style.display = "none";
      document.getElementById("guideBackBtn").style.display = "none";
      break;
    case 'search':
      document.getElementById("searchScreen").style.display = "flex";
      document.getElementById("searchInput").focus();
      document.getElementById("searchInput").value = "";
      document.getElementById("results").innerHTML = "";
      document.getElementById("searchMessage").style.display = "none";
      document.getElementById("backBtn").style.display = "none";
      break;
    case 'contact':
      document.getElementById("contactScreen").style.display = "flex";
      showInsuranceContactsInContactScreen();
      break;
    case 'limit':
      document.getElementById("limitScreen").style.display = "flex";
      initializeLimitScreen();
      break;
  }
}

function updateMenuVisibility() {
  const diseaseMenuBtn = document.getElementById("diseaseMenuBtn");
  
  if (isAdminUser) {
    diseaseMenuBtn.style.display = "block";
  } else {
    diseaseMenuBtn.style.display = "none";
  }
}

function initializeLimitScreen() {
  const productSelect = document.getElementById("productSelect");
  const planSelect = document.getElementById("planSelect");
  const ageSelectRow = document.getElementById("ageSelectRow");
  const ageSelect = document.getElementById("ageSelect");
  const limitResults = document.getElementById("limitResults");
  
  productSelect.selectedIndex = 0;
  planSelect.selectedIndex = 0;
  planSelect.disabled = true;
  ageSelect.selectedIndex = 0;
  ageSelect.disabled = true;
  ageSelectRow.style.display = "none";
  limitResults.innerHTML = "";
  
  // ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
  if (limitData && limitData.length > 0) {
    updateProductSelect();
  } else {
    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
    setTimeout(() => {
      if (limitData && limitData.length > 0) {
        updateProductSelect();
      }
    }, 500);
  }
}

function updateProductSelect() {
  const productSelect = document.getElementById("productSelect");
  
  // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
  while (productSelect.options.length > 1) {
    productSelect.remove(1);
  }
  
  // limitDataê°€ ì—†ìœ¼ë©´ ë¦¬í„´
  if (!limitData || limitData.length === 0) {
    console.log("ì¸ìˆ˜í•œë„ ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }
  
  const { products } = extractProductsAndPlans();
  
  products.forEach(product => {
    const option = document.createElement("option");
    option.value = product;
    option.textContent = product;
    productSelect.appendChild(option);
  });
}

function updatePlanSelect(selectedProduct) {
  const { plans } = extractProductsAndPlans();
  const planSelect = document.getElementById("planSelect");
  const ageSelectRow = document.getElementById("ageSelectRow");
  const ageSelect = document.getElementById("ageSelect");
  const limitResults = document.getElementById("limitResults");
  
  // í”Œëœ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
  while (planSelect.options.length > 1) {
    planSelect.remove(1);
  }
  
  // ì—°ë ¹êµ¬ê°„ ì…€ë ‰íŠ¸ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
  ageSelectRow.style.display = "none";
  ageSelect.disabled = true;
  while (ageSelect.options.length > 1) {
    ageSelect.remove(1);
  }
  
  // ê²°ê³¼ ì´ˆê¸°í™”
  limitResults.innerHTML = "";
  
  if (selectedProduct && plans.has(selectedProduct)) {
    const productPlans = Array.from(plans.get(selectedProduct));
    productPlans.forEach(plan => {
      const option = document.createElement("option");
      option.value = plan;
      option.textContent = plan;
      planSelect.appendChild(option);
    });
    planSelect.disabled = false;
  } else {
    planSelect.disabled = true;
  }
}

function updateAgeSelect(selectedProduct, selectedPlan) {
  const ageSelectRow = document.getElementById("ageSelectRow");
  const ageSelect = document.getElementById("ageSelect");
  const limitResults = document.getElementById("limitResults");
  
  // ì—°ë ¹êµ¬ê°„ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
  while (ageSelect.options.length > 1) {
    ageSelect.remove(1);
  }
  
  // ê²°ê³¼ ì´ˆê¸°í™”
  limitResults.innerHTML = "";
  
  if (selectedProduct && selectedPlan) {
    const ageRanges = extractAgeRanges(selectedProduct, selectedPlan);
    
    ageRanges.forEach(ageRange => {
      const option = document.createElement("option");
      option.value = ageRange;
      option.textContent = ageRange;
      ageSelect.appendChild(option);
    });
    
    ageSelect.disabled = false;
    ageSelectRow.style.display = "block";
  } else {
    ageSelect.disabled = true;
    ageSelectRow.style.display = "none";
  }
}

function searchLimitsAuto(selectedProduct, selectedPlan, selectedAgeRange) {
  const limitResults = document.getElementById("limitResults");
  
  if (!selectedProduct || !selectedPlan || !selectedAgeRange) {
    limitResults.innerHTML = '';
    return;
  }
  
  const tableHTML = generateLimitTable(selectedProduct, selectedPlan, selectedAgeRange);
  
  limitResults.innerHTML = `
    <div class="result-card">
      ${tableHTML}
    </div>
  `;
  
  // ë‹´ë³´ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
  setTimeout(() => {
    const coverageSearchInput = document.getElementById('coverageSearchInput');
    if (coverageSearchInput) {
      coverageSearchInput.addEventListener('input', searchCoverage);
    }
  }, 100);
}

function searchCoverage() {
  const query = document.getElementById('coverageSearchInput').value.trim();
  const rows = document.querySelectorAll('.coverage-row');
  
  if (!query) {
    rows.forEach(row => {
      row.style.display = '';
    });
    return;
  }
  
  const normalizedQuery = normalize(query);
  const tokens = normalizedQuery.split(/[\sÂ·,\-\.]+/).filter(Boolean);
  
  rows.forEach(row => {
    const coverage = row.dataset.coverage;
    const normalizedCoverage = normalize(coverage);
    
    let isMatch = false;
    
    // ëª¨ë“  í† í°ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
    if (tokens.every(token => normalizedCoverage.includes(token))) {
      isMatch = true;
    }
    
    // ë‹¨ì¼ í† í°ì— ëŒ€í•œ ë¶€ë¶„ ë§¤ì¹­ (3ê¸€ì ì´ìƒì¼ ë•Œ)
    if (!isMatch && tokens.length === 1) {
      const token = tokens[0];
      if (token.length >= 3) {
        for (let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
          
          if (left.length >= 2 && right.length >= 2) {
            const leftPos = normalizedCoverage.indexOf(left);
            const rightPos = normalizedCoverage.indexOf(right);
            
            if (leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              isMatch = true;
              break;
            }
          }
        }
      }
    }
    
    row.style.display = isMatch ? '' : 'none';
  });
}

function goBackFromLimit() {
  navigateToScreen('menu');
}

async function loadJsonFlexible(url){
  const res = await fetch(url + "?t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + res.status);
  const text = await res.text();
  const cleaned = text.replace(/^\uFEFF/, "");
  let json = JSON.parse(cleaned);
  if(json && typeof json === "object" && !Array.isArray(json) && Array.isArray(json.data)){
    json = json.data;
  }
  if(!Array.isArray(json)) throw new Error("JSONì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
  return json;
}

async function loadAllData(){
  try{
    const [emp, dis, guide] = await Promise.all([
      loadJsonFlexible(EMP_URL),
      loadJsonFlexible(DIS_URL),
      loadJsonFlexible(GUIDE_URL)
    ]);

    employees = emp.map(e => ({
      empno: String(e.empno || e.code || "").trim(),
      password: String(e.password || "").trim()
    })).filter(e => e.empno && e.password);

    diseases = dis.map(d => ({
      name: String(d.name || "").trim(),
      acceptance: String(d.acceptance || ""),
      signature355: String(d.signature355 || ""),
      treatmentDays: String(d.treatmentDays || ""),
      surgery: String(d.surgery || ""),
      recurrence: String(d.recurrence || ""),
      restrictions: String(d.restrictions || "")
    })).filter(d => d.name);

    guideData = guide.map(g => ({
      name: String(g.DSAS_CSFNM || "").trim(),
      explanation: String(g.DSAS_EXPL || "").trim(),
      healthType: String(g.UD_HTH || ""),
      generalType: String(g.UD_GEN || ""),
      simpleType: String(g.UD_SI || "")
    })).filter(g => g.name || g.explanation);

    await loadLimitData();

    document.getElementById("empMeta").textContent = `ìŠ¹ì¸ì‚¬ë²ˆ ${employees.length}ê±´ â€¢ ì§ˆë³‘ë°ì´í„° ${diseases.length}ê±´ â€¢ í†µí•©ê°€ì´ë“œ ${guideData.length}ê±´`;
  }catch(err){
    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
    document.getElementById("loginMsg").textContent = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
  }
}

function checkAutoLogin() {
  const savedUser = localStorage.getItem('hwg_current_user');
  const savedIsAdmin = localStorage.getItem('hwg_is_admin') === 'true';
  
  if (savedUser) {
    currentUser = savedUser;
    isAdminUser = savedIsAdmin;
    // ìë™ ë¡œê·¸ì¸ ì‹œ ë°”ë¡œ ë©”ë‰´ í™”ë©´ìœ¼ë¡œ ì´ë™
    showLoginSuccess();
  } else {
    const hash = window.location.hash.substring(1);
    if (hash && ['menu', 'guide', 'search', 'contact', 'limit'].includes(hash)) {
      window.location.hash = '';
    }
    navigateToScreen('login', false);
  }
}

function login(){
  const empno = document.getElementById("empno").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  if(!empno || !password) {
    msg.textContent = "ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    return;
  }

  if (empno === ADMIN_ACCOUNT.empno && password === ADMIN_ACCOUNT.password) {
    currentUser = empno;
    isAdminUser = true;
    localStorage.setItem('hwg_current_user', empno);
    localStorage.setItem('hwg_is_admin', 'true');
    showLoginSuccess();
    msg.textContent = "";
    return;
  }

  if(!employees.length){
    msg.textContent = "ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    return;
  }

  const user = employees.find(u => u.empno === empno && u.password === password);
 
  if(user){
    currentUser = empno;
    isAdminUser = false;
    localStorage.setItem('hwg_current_user', empno);
    localStorage.removeItem('hwg_is_admin');
    showLoginSuccess();
    msg.textContent = "";
  }else{
    msg.textContent = "ì½”ë“œ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
}

function hideAllScreens() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("menuScreen").style.display = "none";
  document.getElementById("guideScreen").style.display = "none";
  document.getElementById("searchScreen").style.display = "none";
  document.getElementById("contactScreen").style.display = "none";
  document.getElementById("limitScreen").style.display = "none";
}

function showLoginSuccess() {
  navigateToScreen('menu');
}

function goHome() {
  if (currentUser) {
    navigateToScreen('menu');
  } else {
    navigateToScreen('login');
  }
}

function showGuideScreen() {
  navigateToScreen('guide');
}

function showDiseaseScreen() {
  navigateToScreen('search');
}

function showContactScreen() {
  navigateToScreen('contact');
}

function showLimitScreen() {
  navigateToScreen('limit');
}

// ê°œì„ ëœ ì—°ë½ì²˜ í™”ë©´ í‘œì‹œ í•¨ìˆ˜
function showInsuranceContactsInContactScreen() {
  const insuranceList = document.getElementById("insuranceListContact");
  const damageInsurance = INSURANCE_COMPANIES.slice(1, 12);
  const lifeInsurance = INSURANCE_COMPANIES.slice(12, 18);
  const mutualAid = INSURANCE_COMPANIES.slice(18, 22);
  
  // í•œí™”ì†ë³´ íŠ¹ë³„ ì¹´ë“œ
  const hanwhaCard = `
    <div class="insurance-card hanwha">
      <div class="insurance-logo">${INSURANCE_COMPANIES[0].company}</div>
      <div class="insurance-info">
        <div class="contact-button-group">
          <button class="contact-button call" onclick="handleContactButton('call', '${INSURANCE_COMPANIES[0].callCenter}', '${INSURANCE_COMPANIES[0].company}')">
            ğŸ“ ${INSURANCE_COMPANIES[0].callCenter}
          </button>
          <button class="contact-button fax" onclick="handleContactButton('fax', '${INSURANCE_COMPANIES[0].fax}', '${INSURANCE_COMPANIES[0].company}')">
            ğŸ“  ${INSURANCE_COMPANIES[0].fax}
          </button>
          <button class="contact-button terms" onclick="handleContactButton('terms', '${INSURANCE_COMPANIES[0].termsUrl}', '${INSURANCE_COMPANIES[0].company}')">
            ğŸ”— ê³µì‹œì‹¤ ë°”ë¡œê°€ê¸°
          </button>
        </div>
      </div>
    </div>
  `;
  
  function createCard(company) {
    const faxDisplay = company.fax === "ì½œì„¼í„° ì „í™” ì ‘ìˆ˜" ? "ì½œì„¼í„° ì ‘ìˆ˜" : company.fax;
    
    return `
      <div class="insurance-card small">
        <div class="insurance-logo small">${company.company}</div>
        <div class="insurance-info">
          <div class="contact-button-group">
            <button class="contact-button call" onclick="handleContactButton('call', '${company.callCenter}', '${company.company}')">
              ğŸ“ ${company.callCenter}
            </button>
            <button class="contact-button fax" onclick="handleContactButton('fax', '${company.fax}', '${company.company}')">
              ğŸ“  ${faxDisplay}
            </button>
            <button class="contact-button terms" onclick="handleContactButton('terms', '${company.termsUrl}', '${company.company}')">
              ğŸ”— ê³µì‹œì‹¤
            </button>
          </div>
        </div>
      </div>
    `;
  }
  
  const damageCards = damageInsurance.map(createCard).join('');
  const lifeCards = lifeInsurance.map(createCard).join('');
  const mutualCards = mutualAid.map(createCard).join('');
  
  insuranceList.innerHTML = `
    ${hanwhaCard}
    <div class="insurance-category">
      <h3>ì†í•´ë³´í—˜</h3>
      <div class="insurance-grid">${damageCards}</div>
    </div>
    <div class="insurance-category">
      <h3>ìƒëª…ë³´í—˜</h3>
      <div class="insurance-grid">${lifeCards}</div>
    </div>
    <div class="insurance-category">
      <h3>ê³µì œ</h3>
      <div class="insurance-grid">${mutualCards}</div>
    </div>
  `;
}

function logout() {
  if (currentUser) {
    localStorage.removeItem('hwg_current_user');
    localStorage.removeItem('hwg_is_admin');
    currentUser = null;
    isAdminUser = false;
    screenHistory.length = 0;
    document.getElementById("userInfoHeader").style.display = "none";
    navigateToScreen('login');
    document.getElementById("empno").value = "";
    document.getElementById("password").value = "";
    document.getElementById("guideSearchInput").value = "";
    document.getElementById("searchInput").value = "";
    document.getElementById("guideResults").innerHTML = "";
    document.getElementById("results").innerHTML = "";
  }
}

function normalize(str){
  return String(str || "").toLowerCase().replace(/[\sÂ·,\-\.]/g, "");
}

// í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ê²€ìƒ‰ í•¨ìˆ˜
function searchGuide(){
  const query = document.getElementById("guideSearchInput").value.trim();
  const results = document.getElementById("guideResults");
  const searchMessage = document.getElementById("guideSearchMessage");
  const backBtn = document.getElementById("guideBackBtn");
 
  if(!query){
    searchMessage.style.display = "none";
    results.innerHTML = "";
    backBtn.style.display = "none";
    return;
  }

  if(!guideData.length) {
    searchMessage.innerHTML = '<div class="error">í†µí•© ì¸ìˆ˜ ê°€ì´ë“œ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
    searchMessage.style.display = "block";
    results.innerHTML = "";
    backBtn.style.display = "none";
    return;
  }

  const tokens = query.split(/[\sÂ·,\-\.]+/).filter(Boolean).map(normalize);
 
  const matched = guideData.filter(g => {
    const name = normalize(g.name);
    const explanation = normalize(g.explanation);
   
    // ì§ˆë³‘ëª…(DSAS_CSFNM)ì—ì„œ ê²€ìƒ‰
    if(tokens.every(token => name.includes(token))) {
      return true;
    }
    
    // ì„¤ëª…(DSAS_EXPL)ì—ì„œ ê²€ìƒ‰
    if(tokens.every(token => explanation.includes(token))) {
      return true;
    }
   
    if(tokens.length === 1) {
      const token = tokens[0];
      if(token.length >= 3) {
        // ì§ˆë³‘ëª…ì—ì„œ ë¶€ë¶„ ë§¤ì¹­
        for(let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
         
          if(left.length >= 2 && right.length >= 2) {
            const leftPos = name.indexOf(left);
            const rightPos = name.indexOf(right);
           
            if(leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              return true;
            }
            
            // ì„¤ëª…ì—ì„œë„ ë¶€ë¶„ ë§¤ì¹­
            const leftPosExpl = explanation.indexOf(left);
            const rightPosExpl = explanation.indexOf(right);
           
            if(leftPosExpl >= 0 && rightPosExpl >= 0 && leftPosExpl < rightPosExpl) {
              return true;
            }
          }
        }
      }
    }
   
    return false;
  });

  if(!matched.length){
    searchMessage.innerHTML = '<div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    searchMessage.style.display = "block";
    results.innerHTML = "";
    backBtn.style.display = "block";
    return;
  }

  searchMessage.style.display = "none";
  backBtn.style.display = "block";

  results.innerHTML = matched.map(g => `
    <div class="result-card">
      <div class="result-title">${g.name}</div>
      <table class="guide-table">
        <tr>
          <th>ê³ ì§€ìœ í˜•</th>
          <th>ì‹¬ì‚¬ê¸°ì¤€</th>
        </tr>
        <tr>
          <td class="type-col">ê±´ê°•ê³ ì§€í˜•</td>
          <td class="content-col">${g.healthType || "-"}</td>
        </tr>
        <tr>
          <td class="type-col">ì¼ë°˜ê³ ì§€í˜•</td>
          <td class="content-col">${g.generalType || "-"}</td>
        </tr>
        <tr>
          <td class="type-col">ê°„í¸ê³ ì§€í˜•</td>
          <td class="content-col">${g.simpleType || "-"}</td>
        </tr>
      </table>
    </div>
  `).join('');
}

function search(){
  const query = document.getElementById("searchInput").value.trim();
  const results = document.getElementById("results");
  const searchMessage = document.getElementById("searchMessage");
  const backBtn = document.getElementById("backBtn");
 
  if(!query){
    searchMessage.style.display = "none";
    results.innerHTML = "";
    backBtn.style.display = "none";
    return;
  }

  if(!diseases.length) {
    searchMessage.innerHTML = '<div class="error">ì§ˆë³‘ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
    searchMessage.style.display = "block";
    results.innerHTML = "";
    backBtn.style.display = "none";
    return;
  }

  const tokens = query.split(/[\sÂ·,\-\.]+/).filter(Boolean).map(normalize);
 
  const matched = diseases.filter(d => {
    const name = normalize(d.name);
   
    if(tokens.every(token => name.includes(token))) {
      return true;
    }
   
    if(tokens.length === 1) {
      const token = tokens[0];
      if(token.length >= 3) {
        for(let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
         
          if(left.length >= 2 && right.length >= 2) {
            const leftPos = name.indexOf(left);
            const rightPos = name.indexOf(right);
           
            if(leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              return true;
            }
          }
        }
      }
    }
   
    return false;
  });

  if(!matched.length){
    searchMessage.innerHTML = '<div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    searchMessage.style.display = "block";
    results.innerHTML = "";
    backBtn.style.display = "block";
    return;
  }

  searchMessage.style.display = "none";
  backBtn.style.display = "block";

  results.innerHTML = matched.map(d => `
    <div class="result-card">
      <div class="result-title">${d.name}</div>
      <div class="result-sub">ì¸ìˆ˜ê¸°ì¤€: ${d.acceptance || "-"}</div>
      <div class="result-sub">ì‹œê·¸ë‹ˆì²˜355: ${d.signature355 || "-"}</div>
      <table class="info-table">
        <tr><th>ì¹˜ë£Œì¼ìˆ˜</th><th>ìˆ˜ìˆ ì—¬ë¶€</th><th>ì¬ë°œì—¬ë¶€</th></tr>
        <tr>
          <td>${d.treatmentDays || "-"}</td>
          <td>${d.surgery || "-"}</td>
          <td>${d.recurrence || "-"}</td>
        </tr>
      </table>
      <div class="restrictions">ì œí•œì‚¬í•­: ${d.restrictions || "ì—†ìŒ"}</div>
    </div>
  `).join('');
}

function goBack() {
  const searchInput = document.getElementById("searchInput");
  const results = document.getElementById("results");
  const searchMessage = document.getElementById("searchMessage");
  const backBtn = document.getElementById("backBtn");
  
  searchInput.value = "";
  results.innerHTML = "";
  searchMessage.style.display = "none";
  backBtn.style.display = "none";
}

function goBackFromGuide() {
  const guideSearchInput = document.getElementById("guideSearchInput");
  const guideResults = document.getElementById("guideResults");
  const guideSearchMessage = document.getElementById("guideSearchMessage");
  const guideBackBtn = document.getElementById("guideBackBtn");
  
  guideSearchInput.value = "";
  guideResults.innerHTML = "";
  guideSearchMessage.style.display = "none";
  guideBackBtn.style.display = "none";
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œê·¸ì¸ ì²´í¬ë¥¼ ë¨¼ì € ìˆ˜í–‰
document.addEventListener('DOMContentLoaded', () => {
  if (window.location.hash) {
    history.replaceState({ screen: 'login' }, '', window.location.pathname);
  }
  
  // ìë™ ë¡œê·¸ì¸ ì²´í¬ë¥¼ ë¨¼ì € ìˆ˜í–‰
  checkAutoLogin();
  
  // ê·¸ ë‹¤ìŒ ë°ì´í„° ë¡œë“œ
  loadAllData();
 
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('empno').addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      document.getElementById('password').focus();
    }
  });
  document.getElementById('password').addEventListener('keydown', e => {
    if(e.key === 'Enter') login();
  });

  document.getElementById('guideMenuBtn').addEventListener('click', showGuideScreen);
  document.getElementById('diseaseMenuBtn').addEventListener('click', showDiseaseScreen);
  document.getElementById('contactMenuBtn').addEventListener('click', showContactScreen);
  document.getElementById('limitMenuBtn').addEventListener('click', showLimitScreen);
  document.getElementById('logoutBtnHeader').addEventListener('click', logout);
  document.getElementById('guideSearchBtn').addEventListener('click', searchGuide);
  document.getElementById('guideSearchInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') searchGuide();
  });
  document.getElementById('guideBackBtn').addEventListener('click', goBackFromGuide);
  document.getElementById('searchBtn').addEventListener('click', search);
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') search();
  });
  document.getElementById('backBtn').addEventListener('click', goBack);
  document.getElementById('installBtn').addEventListener('click', () => {
    alert('ë¸Œë¼ìš°ì €ì—ì„œ í™ˆí™”ë©´ ì¶”ê°€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
  });

  document.getElementById('productSelect').addEventListener('change', function() {
    updatePlanSelect(this.value);
  });
  
  document.getElementById('planSelect').addEventListener('change', function() {
    const productSelect = document.getElementById("productSelect");
    if (this.value && productSelect.value) {
      updateAgeSelect(productSelect.value, this.value);
    } else {
      const ageSelectRow = document.getElementById("ageSelectRow");
      const limitResults = document.getElementById("limitResults");
      ageSelectRow.style.display = "none";
      limitResults.innerHTML = "";
    }
  });
  
  document.getElementById('ageSelect').addEventListener('change', function() {
    const productSelect = document.getElementById("productSelect");
    const planSelect = document.getElementById("planSelect");
    if (this.value && productSelect.value && planSelect.value) {
      searchLimitsAuto(productSelect.value, planSelect.value, this.value);
    }
  });
  
  document.getElementById('limitBackBtn').addEventListener('click', goBackFromLimit);
  
  document.querySelector('.close').addEventListener('click', closeNoteModal);
  document.getElementById('noteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeNoteModal();
    }
  });
});
</script>

</body>
</html>
