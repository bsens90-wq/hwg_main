<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>동창원 유병자 인수 가이드</title>
<style>
body {margin:0;font-family:'Segoe UI',sans-serif;background:#fff4e6;}
.container {max-width:600px;margin:3rem auto;padding:2rem;background:white;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.1);}
h1{text-align:center;margin-bottom:2rem;color:#ff6600;}
.form-group{margin-bottom:1.5rem;}
label{display:block;margin-bottom:0.5rem;font-weight:600;color:#333;}
input[type="text"], input[type="password"], input[type="file"]{width:100%;padding:10px;font-size:16px;border:2px solid #ddd;border-radius:6px;outline:none;transition:border-color 0.3s;}
input:focus{border-color:#ff6600;}
button{background:#ff6600;color:white;padding:10px 16px;border:none;border-radius:6px;font-size:16px;cursor:pointer;}
button:hover{background:#e65c00;}
.screen{display:none;}
.screen.active{display:block;}
.error{color:red;font-size:14px;margin-top:0.5rem;}
.success{color:green;font-size:14px;margin-top:0.5rem;}
.search-results{margin-top:2rem;}
.disease-title{font-size:1.2rem;font-weight:bold;margin-bottom:0.5rem;color:#ff6600;}
.acceptance-status{background:#fff7e6;padding:0.6rem;border-radius:5px;margin-bottom:1rem;border-left:4px solid #ff6600;}
.restrictions{background:#ffe5e0;padding:0.6rem;border-radius:5px;margin-top:1rem;}
.conditions-table{width:100%;border-collapse:collapse;margin-top:1rem;}
.conditions-table th, .conditions-table td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
.conditions-table th{background:#f8f9fa;}
.toggle-admin{position:fixed;bottom:20px;right:20px;background:#ffc107;color:#000;padding:0.6rem 1rem;font-size:14px;border:none;border-radius:6px;cursor:pointer;z-index:1000;}
.data-status{background:#e8f4fd;padding:0.8rem;border-radius:6px;margin:1rem 0;font-size:14px;}
.search-info{background:#e3f2fd;padding:0.8rem;border-radius:6px;margin-bottom:1rem;font-size:14px;}
.loading{display:none;text-align:center;color:#666;margin:1rem 0;}
</style>
</head>
<body>

<div class="container">
  <!-- 로그인 화면 -->
  <div id="login-screen" class="screen active">
    <h1>로그인</h1>
    <div id="sync-status" class="data-status">시스템 준비 중...</div>
    <form id="login-form">
      <div class="form-group">
        <label for="login-empno">사번</label>
        <input type="text" id="login-empno" required>
      </div>
      <div class="form-group">
        <label for="login-password">비밀번호</label>
        <input type="password" id="login-password" required>
      </div>
      <button type="submit">로그인</button>
      <div id="login-error" class="error"></div>
    </form>
  </div>

  <!-- 검색 화면 -->
  <div id="main-screen" class="screen">
    <h1>질병명 검색</h1>
    <div class="search-info">
      <strong>검색 가능한 질병:</strong> 총 <span id="total-diseases">0</span>개<br>
      <strong>마지막 업데이트:</strong> <span id="last-update">확인중...</span>
    </div>
    <div class="form-group">
      <label for="disease-search">검색어</label>
      <input type="text" id="disease-search" placeholder="예: 용종, 골절, 염좌, 고혈압, 당뇨 등">
    </div>
    <button type="button" onclick="searchDisease()">검색</button>
    <div class="loading" id="search-loading">검색 중...</div>
    <div id="search-results" class="search-results"></div>
  </div>

  <!-- 관리자 화면 -->
  <div id="admin-screen" class="screen">
    <h1>관리자 모드</h1>
    
    <div class="data-status">
      <strong>현재 데이터:</strong><br>
      승인사번: <span id="emp-count">0</span>개<br>
      질병데이터: <span id="disease-count">0</span>개
    </div>
    
    <div class="form-group">
      <label>승인 사번 CSV 업로드</label>
      <input type="file" id="employee-csv" accept=".csv">
      <button onclick="uploadEmployeeData()" style="background:#007bff;margin-top:0.5rem;">업로드</button>
      <div id="emp-upload-status"></div>
    </div>
    
    <div class="form-group">
      <label>질병 데이터 CSV 업로드</label>
      <input type="file" id="disease-csv" accept=".csv">
      <button onclick="uploadDiseaseData()" style="background:#007bff;margin-top:0.5rem;">업로드</button>
      <div id="disease-upload-status"></div>
    </div>
    
    <button onclick="showScreen('main-screen')">검색 화면으로</button>
    <button onclick="showScreen('login-screen')" style="background:#6c757d;margin-left:0.5rem;">로그아웃</button>
  </div>
</div>

<button class="toggle-admin" onclick="enterAdminMode()">관리자 모드</button>

<script>
const ADMIN_CODE = "admin1234";

// 데이터 저장소
let approvedEmployees = [];
let diseaseData = [];
let lastUpdateTime = new Date().toLocaleString('ko-KR');

// 초기 데이터
const DEFAULT_EMPLOYEES = [
  {empno: "8091768", password: "80917681234"},
  {empno: "8091574", password: "80915741234"},
  {empno: "3242523", password: "32425231234"}
];

const DEFAULT_DISEASES = [
  {name: "대장용종", acceptance: "조건충족시 인수", signature355: "조건충족시 경과 1개월 후 인수", treatmentDays: "입/통원 15일이하", surgery: "수술 有", recurrence: "재발 無", restrictions: "제한 담보 없음"},
  {name: "위용종", acceptance: "조건충족시 인수", signature355: "조건충족시 경과 1개월 후 인수", treatmentDays: "입/통원 15일이하", surgery: "수술 有", recurrence: "재발 無", restrictions: "제한 담보 없음"},
  {name: "고혈압", acceptance: "조건충족시 인수", signature355: "조건충족시 경과 3개월 후 인수", treatmentDays: "통원 지속치료", surgery: "수술 無", recurrence: "무관", restrictions: "심혈관계 관련 담보 인수불가"},
  {name: "당뇨병", acceptance: "조건충족시 인수", signature355: "조건충족시 경과 3개월 후 인수", treatmentDays: "통원 지속치료", surgery: "수술 無", recurrence: "무관", restrictions: "당뇨병 관련 담보 인수불가"},
  {name: "위염", acceptance: "조건충족시 인수", signature355: "조건충족시 경과 1개월 후 인수", treatmentDays: "입/통원 15일이하", surgery: "수술 無", recurrence: "무관", restrictions: "제한 담보 없음"}
];

// CSV 파싱 함수 (UTF-8 인코딩 문제 해결)
function parseCSV(content) {
  try {
    const lines = content.trim().split('\n');
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/["'\r\n]/g, ''));
    console.log('CSV 헤더:', headers);
    
    const result = [];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      
      const values = line.split(',').map(v => v.trim().replace(/["'\r\n]/g, ''));
      const obj = {};
      
      headers.forEach((header, index) => {
        obj[header] = values[index] || '';
      });
      
      // 빈 행 건너뛰기
      if (Object.values(obj).some(val => val !== '')) {
        result.push(obj);
      }
    }
    
    console.log('파싱된 데이터:', result.slice(0, 3));
    return result;
  } catch (error) {
    console.error('CSV 파싱 오류:', error);
    return [];
  }
}

// 승인사번 업로드
async function uploadEmployeeData() {
  const fileInput = document.getElementById('employee-csv');
  const statusDiv = document.getElementById('emp-upload-status');
  
  if (!fileInput.files[0]) {
    alert('CSV 파일을 선택해주세요.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      statusDiv.textContent = '업로드 중...';
      statusDiv.className = 'success';
      
      const csvData = parseCSV(e.target.result);
      const newEmployees = csvData.filter(row => row.empno && row.password);

      if (newEmployees.length === 0) {
        statusDiv.textContent = '❌ 유효한 데이터가 없습니다. CSV 형식을 확인하세요 (empno,password)';
        statusDiv.className = 'error';
        return;
      }

      approvedEmployees = newEmployees;
      lastUpdateTime = new Date().toLocaleString('ko-KR');
      
      // 로컬 저장소에 저장 (모든 사용자 공유)
      localStorage.setItem('shared_employees', JSON.stringify({
        data: approvedEmployees,
        lastUpdate: lastUpdateTime,
        timestamp: Date.now()
      }));
      
      updateCounts();
      statusDiv.textContent = `✅ 성공! ${newEmployees.length}개 승인사번이 업데이트되었습니다.`;
      
    } catch (error) {
      statusDiv.textContent = '❌ 파일 읽기 실패. UTF-8 인코딩으로 저장했는지 확인하세요.';
      statusDiv.className = 'error';
    }
  };
  
  reader.readAsText(file, 'UTF-8');
}

// 질병 데이터 업로드
async function uploadDiseaseData() {
  const fileInput = document.getElementById('disease-csv');
  const statusDiv = document.getElementById('disease-upload-status');
  
  if (!fileInput.files[0]) {
    alert('CSV 파일을 선택해주세요.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      statusDiv.textContent = '업로드 중...';
      statusDiv.className = 'success';
      
      const csvData = parseCSV(e.target.result);
      const validDiseases = csvData.filter(row => row.name);

      if (validDiseases.length === 0) {
        statusDiv.textContent = '❌ 유효한 데이터가 없습니다. CSV 형식을 확인하세요';
        statusDiv.className = 'error';
        return;
      }

      diseaseData = validDiseases;
      lastUpdateTime = new Date().toLocaleString('ko-KR');
      
      // 로컬 저장소에 저장 (모든 사용자 공유)
      localStorage.setItem('shared_diseases', JSON.stringify({
        data: diseaseData,
        lastUpdate: lastUpdateTime,
        timestamp: Date.now()
      }));
      
      updateCounts();
      statusDiv.textContent = `✅ 성공! ${validDiseases.length}개 질병 데이터가 업데이트되었습니다.`;
      
    } catch (error) {
      statusDiv.textContent = '❌ 파일 읽기 실패. UTF-8 인코딩으로 저장했는지 확인하세요.';
      statusDiv.className = 'error';
    }
  };
  
  reader.readAsText(file, 'UTF-8');
}

// 데이터 카운트 업데이트
function updateCounts() {
  const elements = {
    'emp-count': approvedEmployees.length,
    'disease-count': diseaseData.length,
    'total-diseases': diseaseData.length,
    'last-update': lastUpdateTime
  };
  
  Object.keys(elements).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = elements[id];
    }
  });
}

// 저장된 데이터 로드
function loadStoredData() {
  try {
    const storedEmployees = localStorage.getItem('shared_employees');
    const storedDiseases = localStorage.getItem('shared_diseases');
    
    if (storedEmployees) {
      const empData = JSON.parse(storedEmployees);
      approvedEmployees = empData.data || DEFAULT_EMPLOYEES;
      lastUpdateTime = empData.lastUpdate || lastUpdateTime;
    } else {
      approvedEmployees = DEFAULT_EMPLOYEES;
    }
    
    if (storedDiseases) {
      const diseaseDataResponse = JSON.parse(storedDiseases);
      diseaseData = diseaseDataResponse.data || DEFAULT_DISEASES;
      lastUpdateTime = diseaseDataResponse.lastUpdate || lastUpdateTime;
    } else {
      diseaseData = DEFAULT_DISEASES;
    }
    
    updateCounts();
    
    document.getElementById('sync-status').textContent = '시스템 준비 완료';
    
  } catch (error) {
    console.error('데이터 로드 오류:', error);
    approvedEmployees = DEFAULT_EMPLOYEES;
    diseaseData = DEFAULT_DISEASES;
    updateCounts();
  }
}

// 검색 함수
function searchDisease() {
  const input = document.getElementById('disease-search').value.trim();
  const resultsDiv = document.getElementById('search-results');
  const loadingDiv = document.getElementById('search-loading');
  
  resultsDiv.innerHTML = '';
  
  if (!input) {
    resultsDiv.innerHTML = '<p>검색어를 입력해주세요.</p>';
    return;
  }

  loadingDiv.style.display = 'block';
  
  setTimeout(() => {
    loadingDiv.style.display = 'none';
    
    // 간단한 검색: 포함 검색
    const searchLower = input.toLowerCase();
    const matched = diseaseData.filter(disease => {
      return disease.name && disease.name.toLowerCase().includes(searchLower);
    });

    if (matched.length === 0) {
      resultsDiv.innerHTML = `
        <div style="background:#fff3cd; padding:1rem; border-radius:5px;">
          <strong>"${input}"에 대한 결과가 없습니다.</strong><br><br>
          <strong>사용 가능한 검색어 예시:</strong><br>
          ${diseaseData.slice(0, 5).map(d => `• ${d.name}`).join('<br>')}
        </div>
      `;
      return;
    }

    // 결과 표시 (최대 10개)
    const displayMatched = matched.slice(0, 10);
    
    displayMatched.forEach((disease, index) => {
      resultsDiv.innerHTML += `
        <div class="disease-title">${disease.name}</div>
        <div class="acceptance-status">
          <strong>인수 결과:</strong> ${disease.acceptance || '정보없음'}<br>
          <strong>시그니처355:</strong> ${disease.signature355 || '정보없음'}
        </div>
        <table class="conditions-table">
          <tr><th>치료일수</th><th>수술여부</th><th>재발여부</th></tr>
          <tr>
            <td>${disease.treatmentDays || '정보없음'}</td>
            <td>${disease.surgery || '정보없음'}</td>
            <td>${disease.recurrence || '정보없음'}</td>
          </tr>
        </table>
        <div class="restrictions"><strong>가입제한:</strong> ${disease.restrictions || '정보없음'}</div>
        ${index < displayMatched.length - 1 ? '<hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">' : ''}
      `;
    });

    // 결과 개수 표시
    if (matched.length > 0) {
      const summary = matched.length > 10 ? 
        `총 ${matched.length}개 중 처음 10개를 표시합니다.` : 
        `${matched.length}개의 검색 결과를 찾았습니다.`;
      
      resultsDiv.insertAdjacentHTML('afterbegin', 
        `<div style="background:#e8f5e8; padding:0.5rem; border-radius:5px; margin-bottom:1rem; text-align:center;">
          <strong>${summary}</strong>
        </div>`);
    }
  }, 300);
}

// 로그인 처리
document.getElementById('login-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const empno = document.getElementById('login-empno').value.trim();
  const password = document.getElementById('login-password').value.trim();
  const user = approvedEmployees.find(u => u.empno === empno && u.password === password);
  
  if (user) {
    showScreen('main-screen');
    document.getElementById('login-error').textContent = '';
  } else {
    document.getElementById('login-error').textContent = '사번 또는 비밀번호가 올바르지 않습니다.';
  }
});

// 화면 전환
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  updateCounts();
}

// 관리자 모드
function enterAdminMode() {
  const code = prompt('관리자 코드를 입력하세요:');
  if (code === ADMIN_CODE) {
    showScreen('admin-screen');
  } else {
    alert('잘못된 코드입니다.');
  }
}

// 엔터키 검색
document.getElementById('disease-search').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchDisease();
  }
});

// 초기화
window.addEventListener('load', function() {
  loadStoredData();
});

// 스토리지 변경 감지 (다른 탭에서 업데이트 시)
window.addEventListener('storage', function(e) {
  if (e.key === 'shared_employees' || e.key === 'shared_diseases') {
    loadStoredData();
  }
});
</script>
</body>
</html>
