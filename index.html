<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>유병자 인수가이드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekSDsnbTsiJjqsIDsnbTrk5wiLCJzaG9ydF9uYW1lIjoi7ZWc7ZmU7Jqw67O07JuQIOycoOuzteyekyIsInN0YXJ0X3VybCI6Ii4vaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjZmY3ZjAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGY5ZmEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yV3lCM2FXUjBhRDBpTWpRd0lpQm9aV2xuYUhROUlqSTBNQ0lnZG1sbGQwSnZlRDBpTUNBd0lESTBNQ0F5TkRBaUlHWnBiR3c5SWlObVpqZG1NREFpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaaTh5TURBd0wzTjJaeUkrUEdOcGNtTnNaU0JqZUQwaU1USTBJaUJqZVQwaU1USTBJaUJ5UFNJeE1ERWlJR1pwYkd3OUlpTm1aalk0REFBMU9VNGlMejRBUEhCaGRHZ2daRDBpVFRFME9TQXRNRGxDTGpBeFNIazNOem93TlFGc05qZ3VPRGd1TURNMUxqQXhObDBpSUdacGJHdzlJaU5tWmpkbU1EQWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" />
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.reset{
      background:#dc3545;
      margin-top:8px;
    }
    button.reset:hover{background:#c82333}
    button.debug{
      background:#17a2b8;
      margin-bottom:8px;
    }
    button.debug:hover{background:#138496}
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#137333; font-size:13px}
    .debug{color:#17a2b8; font-size:12px; margin-top:.5rem; background:#f8f9fa; padding:8px; border-radius:5px; font-family:monospace; white-space:pre-wrap; max-height:200px; overflow-y:auto;}
    .container-narrow{max-width:760px}
    .results{margin-top:1rem}
    .result-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:12px;
    }
    .result-title{
      font-size:18px;
      font-weight:700;
      color:#222;
      margin-bottom:6px;
    }
    .result-sub{color:#444; margin:.25rem 0 .5rem 0}
    .info-table{
      width:100%;
      border-collapse:collapse;
      margin-top:.25rem;
      font-size:14px;
    }
    .info-table th,.info-table td{
      border:1px solid var(--border);
      padding:8px;
      text-align:center;
      white-space:nowrap;
    }
    .restrictions{
      margin-top:.5rem;
      padding:.5rem .75rem;
      background:#fafafa;
      border:1px dashed var(--border);
      border-radius:10px;
      font-size:14px;
      white-space:pre-line;
    }
    .meta{
      margin-top:.5rem;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .install-prompt{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--hanwha);
      color:white;
      padding:12px 20px;
      border-radius:25px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      display:none;
      z-index:1000;
      cursor:pointer;
      font-weight:700;
    }
    .admin-btn{
      position:fixed;
      bottom:10px;
      right:10px;
      width:40px;
      height:40px;
      background:rgba(108,117,125,0.8);
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:12px;
      font-weight:700;
      border:none;
    }
    .log-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      margin-bottom:8px;
      font-size:14px;
    }
    .log-header{
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:4px;
    }
    .log-time{
      color:var(--muted);
      font-size:12px;
    }
    .log-search{
      background:#f0f8ff;
      padding:4px 8px;
      border-radius:5px;
      margin-top:4px;
      font-family:monospace;
    }
    .user-info{
      position:fixed;
      top:10px;
      right:10px;
      background:rgba(255,127,0,0.1);
      padding:8px 12px;
      border-radius:20px;
      font-size:12px;
      color:var(--hanwha);
      font-weight:600;
    }
    .loading{
      display:inline-block;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
  </style>
</head>
<body>
 <!-- 로그인 화면 -->
<section id="loginScreen" class="screen">
  <div class="app-title">한화손보 유병자 인수 가이드</div>
  <div class="card">
    <h2>로그인</h2>
    <div class="row">
      <input id="empno" type="text" placeholder="코드 입력" autocomplete="username" />
    </div>
    <div class="row">
      <input id="password" type="password" placeholder="비밀번호 입력" autocomplete="current-password" />
      <div class="hint">코드는 사전 승인된 기관에 부여됩니다.</div>
    </div>
    <button id="loginBtn">로그인</button>
    <button id="installBtn" class="secondary">홈화면에 추가</button>
    <div id="loginMsg" class="error" role="alert" aria-live="polite"></div>
    <div class="meta" id="empMeta"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 하세봉 all rights reserved.</div>
  </div>
</section>

<!-- 검색 화면 -->
<section id="searchScreen" class="screen" style="display:none;">
  <div class="user-info" id="userInfo"></div>
  <div class="app-title">한화손보 유병자 인수 가이드</div>
  <div class="card container-narrow">
    <h2 style="margin-bottom:.5rem;">질병명 검색</h2>
    <div class="row">
      <input id="searchInput" type="text" placeholder="예시: 용종, 골절, 당뇨 등" />
    </div>
    <button id="searchBtn" title="검색">검색</button>
    <div class="results" id="results"></div>
    <div class="meta" id="disMeta"></div>
    <div class="debug" id="debugInfo" style="display:none;"></div>
    <div class="meta" style="margin-top:1rem;">Copyright 2025 하세봉 all rights reserved.</div>
  </div>
</section>

  <!-- 관리자 로그 화면 -->
  <section id="adminScreen" class="screen" style="display:none;">
    <div class="app-title">관리자 로그 조회</div>
    <div class="card container-narrow">
      <h2>사용자 활동 로그</h2>
      <div class="row">
        <input id="adminPassword" type="password" placeholder="관리자 비밀번호를 입력하세요." />
      </div>
      <button id="loadLogsBtn">로그 불러오기</button>
      <button id="testGitHubBtn" class="debug">GitHub 연결 테스트</button>
      <button id="resetLoginBtn" class="reset">모든 사용자 로그인 초기화</button>
      <button id="backToSearchBtn" class="secondary">검색화면으로 돌아가기</button>
      <div id="adminMsg" class="error"></div>
      <div class="debug" id="githubDebug"></div>
      <div class="meta" id="logStats"></div>
      <div id="logResults" class="results"></div>
    </div>
  </section>

  <!-- PWA 설치 프롬프트 -->
  <div id="installPrompt" class="install-prompt">홈화면에 추가하기</div>

  <!-- 관리자 버튼 -->
  <button id="adminBtn" class="admin-btn" title="관리자">Admin</button>

<script>
// 전역 변수
let employees = [];
let diseases = [];
let currentUser = null;
let userLogs = [];

// PWA 설치 관련
let deferredPrompt;

// 데이터 URL
const EMP_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/employees.json";
const DIS_URL = "https://raw.githubusercontent.com/bsens90-wq/hwg_main/main/data/diseases.json";

// GitHub 로그 설정
const GITHUB_CONFIG = {
  owner: 'bsens90-wq',
  repo: 'patient-guide-logs', // 실제 생성한 리포지토리명으로 수정
  path: 'logs/user_logs.json',
  token: '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', // 실제 토큰으로 교체하세요
  branch: 'main'
};

// 디버그 정보 표시
function showDebug(message, isError = false) {
  const debugElement = document.getElementById('debugInfo');
  const githubDebugElement = document.getElementById('githubDebug');
  
  const timestamp = new Date().toLocaleTimeString();
  const debugMsg = `[${timestamp}] ${message}\n`;
  
  if (debugElement) {
    debugElement.style.display = 'block';
    debugElement.textContent += debugMsg;
    debugElement.scrollTop = debugElement.scrollHeight;
  }
  if (githubDebugElement) {
    githubDebugElement.textContent += debugMsg;
    githubDebugElement.scrollTop = githubDebugElement.scrollHeight;
  }
  
  console.log(isError ? 'ERROR:' : 'DEBUG:', message);
}

// GitHub 연결 테스트
async function testGitHubConnection() {
  const msg = document.getElementById("adminMsg");
  const password = document.getElementById("adminPassword").value.trim();
  
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }
  
  msg.textContent = "";
  showDebug("=== GitHub 연결 테스트 시작 ===");
  
  // 토큰 상태 확인
  showDebug(`토큰 길이: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : '없음'}`);
  showDebug(`토큰 시작: ${GITHUB_CONFIG.token ? GITHUB_CONFIG.token.substring(0, 10) + '...' : '없음'}`);
  
  if (!GITHUB_CONFIG.token || GITHUB_CONFIG.token === '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') {
    showDebug("GitHub 토큰이 설정되지 않았습니다. 코드에서 토큰을 설정해주세요.", true);
    msg.textContent = "토큰이 설정되지 않았습니다. 코드를 수정해주세요.";
    return;
  }

  try {
    // 1. 기본 GitHub API 응답 테스트
    showDebug("1. GitHub API 기본 연결 테스트...");
    const basicResponse = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    showDebug(`기본 API 응답: ${basicResponse.status} ${basicResponse.statusText}`);
    
    if (basicResponse.ok) {
      const userData = await basicResponse.json();
      showDebug(`인증된 사용자: ${userData.login}`);
    } else {
      const errorData = await basicResponse.json();
      showDebug(`기본 API 오류: ${JSON.stringify(errorData)}`, true);
    }

    // 2. 리포지토리 접근 테스트
    showDebug("2. 리포지토리 접근 테스트...");
    const repoUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`;
    showDebug(`리포지토리 URL: ${repoUrl}`);
    
    const repoResponse = await fetch(repoUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`리포지토리 응답: ${repoResponse.status} ${repoResponse.statusText}`);

    if (!repoResponse.ok) {
      const errorText = await repoResponse.text();
      showDebug(`리포지토리 오류 내용: ${errorText}`, true);
      throw new Error(`리포지토리 접근 실패: ${repoResponse.status}`);
    }

    const repoData = await repoResponse.json();
    showDebug(`리포지토리명: ${repoData.name}, 공개여부: ${repoData.private ? 'Private' : 'Public'}`);

    // 3. 파일 접근 테스트
    showDebug("3. 로그 파일 접근 테스트...");
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    showDebug(`파일 URL: ${fileUrl}`);
    
    const fileResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    showDebug(`파일 접근 응답: ${fileResponse.status} ${fileResponse.statusText}`);

    if (fileResponse.ok) {
      const fileData = await fileResponse.json();
      showDebug(`파일 존재함: ${GITHUB_CONFIG.path}`);
      showDebug(`파일 크기: ${fileData.size} bytes, SHA: ${fileData.sha}`);
      
      try {
        const content = atob(fileData.content);
        const logs = JSON.parse(content);
        showDebug(`현재 로그 개수: ${logs.length}개`);
        
        if (logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          showDebug(`최근 로그: ${lastLog.date} - ${lastLog.empno} - ${lastLog.action}`);
        }
      } catch (parseError) {
        showDebug(`파일 파싱 오류: ${parseError.message}`, true);
      }
      
    } else if (fileResponse.status === 404) {
      showDebug("파일이 존재하지 않음. 첫 로그 저장 시 자동 생성됩니다.");
      
      // 4. 파일 생성 테스트
      showDebug("4. 파일 생성 테스트...");
      const testLog = [{
        empno: "TEST",
        action: "test_connection",
        details: "GitHub 연결 테스트",
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('ko-KR')
      }];
      
      const createResponse = await fetch(fileUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_CONFIG.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'GitHub 연결 테스트 - 로그 파일 생성',
          content: btoa(JSON.stringify(testLog, null, 2)),
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (createResponse.ok) {
        showDebug("테스트 파일 생성 성공!");
      } else {
        const createErrorText = await createResponse.text();
        showDebug(`파일 생성 실패: ${createResponse.status} - ${createErrorText}`, true);
      }
      
    } else {
      const errorText = await fileResponse.text();
      showDebug(`파일 접근 오류: ${fileResponse.status} - ${errorText}`, true);
    }

    showDebug("=== GitHub 연결 테스트 완료 ===");
    msg.innerHTML = '<span class="success">GitHub 연결 테스트 완료! 디버그 정보를 확인하세요.</span>';

  } catch (error) {
    showDebug(`GitHub 연결 테스트 실패: ${error.message}`, true);
    msg.textContent = `GitHub 연결 실패: ${error.message}`;
  }
}

// 자동 로그인 체크
function checkAutoLogin() {
  const savedUser = localStorage.getItem('hwg_current_user');
  if (savedUser) {
    currentUser = savedUser;
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("searchScreen").style.display = "flex";
    document.getElementById("userInfo").textContent = `로그인: ${currentUser}`;
    document.getElementById("searchInput").focus();
    showDebug(`자동 로그인: ${currentUser}`);
  }
}

// GitHub 로그 저장 함수 (디버깅 추가)
async function saveLogToGitHub(empno, action, details = '') {
  const log = {
    empno: empno,
    action: action,
    details: details,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleString('ko-KR'),
    userAgent: navigator.userAgent.substring(0, 100),
    ip: 'client-side'
  };

  try {
    // 로컬에도 저장 (기존 로직 유지)
    const logs = JSON.parse(localStorage.getItem('userLogs') || '[]');
    logs.push(log);
    if(logs.length > 500) {
      logs.splice(0, logs.length - 500);
    }
    localStorage.setItem('userLogs', JSON.stringify(logs));
    showDebug(`로컬 저장 완료: ${action} by ${empno}`);

    // GitHub에 로그 저장
    if (GITHUB_CONFIG.token && GITHUB_CONFIG.token !== 'YOUR_NEW_TOKEN_HERE' && GITHUB_CONFIG.token !== null) {
      showDebug(`GitHub 저장 시도: ${action} by ${empno}`);
      await appendLogToGitHub(log);
      showDebug(`GitHub 저장 완료: ${action} by ${empno}`);
    } else {
      showDebug('GitHub 로그 저장 비활성화됨 - 로컬 저장만 사용');
    }
    
  } catch (error) {
    showDebug(`GitHub 로그 저장 실패: ${error.message}`, true);
  }
}

// GitHub API를 통한 로그 추가 (디버깅 강화)
async function appendLogToGitHub(newLog) {
  try {
    const fileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
    
    // 현재 파일 내용 가져오기
    const getResponse = await fetch(fileUrl, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    let existingLogs = [];
    let sha = null;

    if (getResponse.ok) {
      const data = await getResponse.json();
      sha = data.sha;
      const content = atob(data.content);
      existingLogs = JSON.parse(content);
      showDebug(`기존 로그 ${existingLogs.length}개 발견`);
    } else if (getResponse.status === 404) {
      showDebug("파일이 존재하지 않음. 새로 생성합니다.");
    } else {
      throw new Error(`파일 가져오기 실패: ${getResponse.status}`);
    }

    // 새 로그 추가
    existingLogs.push(newLog);
    
    // 최대 1000개 로그만 유지
    if (existingLogs.length > 1000) {
      existingLogs = existingLogs.slice(-1000);
    }

    const newContent = btoa(JSON.stringify(existingLogs, null, 2));

    // GitHub에 업데이트
    const updatePayload = {
      message: `Add log: ${newLog.action} by ${newLog.empno}`,
      content: newContent,
      branch: GITHUB_CONFIG.branch
    };
    
    if (sha) {
      updatePayload.sha = sha;
    }

    const updateResponse = await fetch(fileUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatePayload)
    });

    if (!updateResponse.ok) {
      const errorText = await updateResponse.text();
      throw new Error(`GitHub 업데이트 실패: ${updateResponse.status} - ${errorText}`);
    }

    showDebug(`GitHub 업데이트 성공: 총 ${existingLogs.length}개 로그`);

  } catch (error) {
    showDebug(`GitHub 로그 저장 오류: ${error.message}`, true);
    throw error;
  }
}

// GitHub에서 로그 불러오기
async function loadLogsFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      throw new Error(`GitHub API 오류: ${response.status}`);
    }

    const data = await response.json();
    const content = atob(data.content);
    return JSON.parse(content);
  } catch (error) {
    showDebug(`GitHub 로그 불러오기 실패: ${error.message}`, true);
    // GitHub에서 불러오기 실패시 로컬 로그 반환
    return JSON.parse(localStorage.getItem('userLogs') || '[]');
  }
}

// 로그 기록 함수 (기존 로직 유지하면서 GitHub 연동 추가)
function saveLog(empno, action, details = '') {
  saveLogToGitHub(empno, action, details);
}

// PWA 설치 이벤트
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installPrompt').style.display = 'block';
});

// JSON 로더
async function loadJsonFlexible(url){
  const res = await fetch(url + "?t=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("네트워크 오류: " + res.status);
 
  const text = await res.text();
  const cleaned = text.replace(/^\uFEFF/, "");
  let json = JSON.parse(cleaned);

  if(json && typeof json === "object" && !Array.isArray(json) && Array.isArray(json.data)){
    json = json.data;
  }
  if(!Array.isArray(json)) throw new Error("JSON이 배열이 아닙니다.");
 
  return json;
}

// 데이터 로드
async function loadAllData(){
  try{
    const [emp, dis] = await Promise.all([
      loadJsonFlexible(EMP_URL),
      loadJsonFlexible(DIS_URL)
    ]);

    employees = emp.map(e => ({
      empno: String(e.empno || e.code || "").trim(),
      password: String(e.password || "").trim()
    })).filter(e => e.empno && e.password);

    diseases = dis.map(d => ({
      name: String(d.name || "").trim(),
      acceptance: String(d.acceptance || ""),
      signature355: String(d.signature355 || ""),
      treatmentDays: String(d.treatmentDays || ""),
      surgery: String(d.surgery || ""),
      recurrence: String(d.recurrence || ""),
      restrictions: String(d.restrictions || "")
    })).filter(d => d.name);

    document.getElementById("empMeta").textContent =
      `승인사번 ${employees.length}건 • 질병데이터 ${diseases.length}건`;

  }catch(err){
    console.error("데이터 로드 실패:", err);
    document.getElementById("loginMsg").textContent = "데이터 로드 실패";
  }
}

// 로그인
function login(){
  const empno = document.getElementById("empno").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  if(!employees.length){
    msg.textContent = "데이터가 로드되지 않았습니다.";
    return;
  }

  const user = employees.find(u => u.empno === empno && u.password === password);
 
  if(user){
    currentUser = empno;
    
    // 로그인 상태 저장 (자동 로그인용)
    localStorage.setItem('hwg_current_user', empno);
    
    saveLog(empno, 'login');
   
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("searchScreen").style.display = "flex";
    document.getElementById("userInfo").textContent = `로그인: ${empno}`;
    document.getElementById("searchInput").focus();
    msg.textContent = "";
  }else{
    msg.textContent = "코드 또는 비밀번호가 올바르지 않습니다.";
  }
}

// 검색 정규화
function normalize(str){
  return String(str || "").toLowerCase().replace(/[\sÂ·,\-\.]/g, "");
}

// 검색
function search(){
  const query = document.getElementById("searchInput").value.trim();
  const results = document.getElementById("results");
 
  if(!query){
    results.innerHTML = '<div class="hint">검색어를 입력하세요.</div>';
    return;
  }

  // 검색 로그 저장
  if(currentUser) {
    saveLog(currentUser, 'search', query);
  }

  const tokens = query.split(/[\sÂ·,\-\.]+/).filter(Boolean).map(normalize);
 
  const matched = diseases.filter(d => {
    const name = normalize(d.name);
   
    // 기본 검색 (공백으로 분리된 토큰들이 모두 포함)
    if(tokens.every(token => name.includes(token))) {
      return true;
    }
   
    // 단일 토큰 분할 검색 (3글자 이상, 2글자씩 조합, 순서 고려)
    if(tokens.length === 1) {
      const token = tokens[0];
      if(token.length >= 3) {
        for(let i = 2; i <= token.length - 2; i++) {
          const left = token.substring(0, i);
          const right = token.substring(i);
         
          if(left.length >= 2 && right.length >= 2) {
            const leftPos = name.indexOf(left);
            const rightPos = name.indexOf(right);
           
            if(leftPos >= 0 && rightPos >= 0 && leftPos < rightPos) {
              return true;
            }
          }
        }
      }
    }
   
    return false;
  });

  if(!matched.length){
    results.innerHTML = '<div class="hint">검색 결과가 없습니다.</div>';
    return;
  }

  results.innerHTML = matched.map(d => `
    <div class="result-card">
      <div class="result-title">${d.name}</div>
      <div class="result-sub">인수기준: ${d.acceptance || "-"}</div>
      <div class="result-sub">시그니처355: ${d.signature355 || "-"}</div>
      <table class="info-table">
        <tr><th>치료일수</th><th>수술여부</th><th>재발여부</th></tr>
        <tr>
          <td>${d.treatmentDays || "-"}</td>
          <td>${d.surgery || "-"}</td>
          <td>${d.recurrence || "-"}</td>
        </tr>
      </table>
      <div class="restrictions">제한사항: ${d.restrictions || "없음"}</div>
    </div>
  `).join('');
}

// 관리자 로그인 초기화
function resetAllLogins() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }

  // 모든 사용자의 로그인 상태 초기화
  localStorage.removeItem('hwg_current_user');
  
  // 현재 사용자도 로그아웃
  currentUser = null;
  
  msg.innerHTML = '<span class="success">모든 사용자의 로그인 상태가 초기화되었습니다.</span>';
  
  // 초기화 로그 기록
  saveLogToGitHub('ADMIN', 'reset_all_logins', 'All user login states reset');
}

// 관리자 로그 불러오기 (GitHub 연동)
async function loadLogs() {
  const password = document.getElementById("adminPassword").value.trim();
  const msg = document.getElementById("adminMsg");
  const loadBtn = document.getElementById("loadLogsBtn");
 
  if(password !== "admin123") {
    msg.textContent = "관리자 비밀번호가 올바르지 않습니다.";
    return;
  }
 
  msg.textContent = "";
  loadBtn.innerHTML = '<span class="loading">⟳</span> 로그 불러오는 중...';
  loadBtn.disabled = true;

  try {
    showDebug("관리자 로그 불러오기 시작...");
    
    // GitHub에서 로그 불러오기
    userLogs = await loadLogsFromGitHub();
    userLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
   
    const stats = document.getElementById("logStats");
    const results = document.getElementById("logResults");
   
    // 통계
    const totalLogs = userLogs.length;
    const uniqueUsers = new Set(userLogs.map(l => l.empno)).size;
    const loginCount = userLogs.filter(l => l.action === 'login').length;
    const searchCount = userLogs.filter(l => l.action === 'search').length;
   
    stats.textContent = `전체 ${totalLogs}개 | 사용자 ${uniqueUsers}명 | 로그인 ${loginCount}회 | 검색 ${searchCount}회`;
    showDebug(`로그 통계: 총 ${totalLogs}개, 사용자 ${uniqueUsers}명`);
   
    // 로그 목록
    if(userLogs.length === 0) {
      results.innerHTML = '<div class="hint">로그 데이터가 없습니다.</div>';
    } else {
      results.innerHTML = userLogs.map(log => `
        <div class="log-card">
          <div class="log-header">코드: ${log.empno} - ${log.action === 'login' ? '로그인' : log.action === 'search' ? '검색' : log.action}</div>
          <div class="log-time">${log.date}</div>
          ${log.details ? `<div class="log-search">검색어: "${log.details}"</div>` : ''}
        </div>
      `).join('');
    }
    
    showDebug("로그 불러오기 완료");
  } catch (error) {
    showDebug(`로그 불러오기 실패: ${error.message}`, true);
    msg.textContent = "로그 불러오기 실패: " + error.message;
  } finally {
    loadBtn.innerHTML = '로그 불러오기';
    loadBtn.disabled = false;
  }
}

// 이벤트 리스너
document.addEventListener('DOMContentLoaded', () => {
  // 데이터 로드 및 자동 로그인 체크
  Promise.all([loadAllData()]).then(() => {
    checkAutoLogin();
  });
 
  // 로그인
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('empno').addEventListener('keydown', e => {
    if(e.key === 'Enter') login();
  });
  document.getElementById('password').addEventListener('keydown', e => {
    if(e.key === 'Enter') login();
  });
 
  // 검색
  document.getElementById('searchBtn').addEventListener('click', search);
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') search();
  });
 
  // 관리자
  document.getElementById('adminBtn').addEventListener('click', () => {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('searchScreen').style.display = 'none';
    document.getElementById('adminScreen').style.display = 'flex';
  });
 
  document.getElementById('loadLogsBtn').addEventListener('click', loadLogs);
  document.getElementById('adminPassword').addEventListener('keydown', e => {
    if(e.key === 'Enter') loadLogs();
  });

  // GitHub 테스트 버튼
  document.getElementById('testGitHubBtn').addEventListener('click', testGitHubConnection);

  // 로그인 상태 초기화 버튼
  document.getElementById('resetLoginBtn').addEventListener('click', resetAllLogins);
 
  document.getElementById('backToSearchBtn').addEventListener('click', () => {
    document.getElementById('adminScreen').style.display = 'none';
    if(currentUser) {
      document.getElementById('searchScreen').style.display = 'flex';
    } else {
      document.getElementById('loginScreen').style.display = 'flex';
    }
  });
 
  // PWA 설치
  document.getElementById('installBtn').addEventListener('click', async () => {
    if(deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    } else {
      alert('브라우저에서 홈화면 추가 기능을 사용해주세요.');
    }
  });
 
  document.getElementById('installPrompt').addEventListener('click', () => {
    document.getElementById('installBtn').click();
  });
});
</script>

</body>
</html>
